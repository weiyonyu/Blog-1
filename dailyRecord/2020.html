<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>2020 项目经验总结 | Notebook</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="">
    <meta name="description" content="📝每天记录一点点">
    
    <link rel="preload" href="./assets/css/0.styles.81cbcbf8.css" as="style"><link rel="preload" href="./assets/js/app.09835454.js" as="script"><link rel="preload" href="./assets/js/3.9a8cb714.js" as="script"><link rel="preload" href="./assets/js/5.2b9a4ed4.js" as="script"><link rel="prefetch" href="./assets/js/10.beb9865c.js"><link rel="prefetch" href="./assets/js/11.a7dda998.js"><link rel="prefetch" href="./assets/js/12.b8ec8d23.js"><link rel="prefetch" href="./assets/js/13.481ecb00.js"><link rel="prefetch" href="./assets/js/14.2c7e4b48.js"><link rel="prefetch" href="./assets/js/15.47995415.js"><link rel="prefetch" href="./assets/js/16.1e2bf8c4.js"><link rel="prefetch" href="./assets/js/17.7a89769a.js"><link rel="prefetch" href="./assets/js/18.fcadf835.js"><link rel="prefetch" href="./assets/js/19.231d3618.js"><link rel="prefetch" href="./assets/js/2.33905da3.js"><link rel="prefetch" href="./assets/js/20.a85f560c.js"><link rel="prefetch" href="./assets/js/21.e075c040.js"><link rel="prefetch" href="./assets/js/22.bb17a60f.js"><link rel="prefetch" href="./assets/js/23.8188ff03.js"><link rel="prefetch" href="./assets/js/24.345a91d7.js"><link rel="prefetch" href="./assets/js/25.5b2c444b.js"><link rel="prefetch" href="./assets/js/26.2eebd931.js"><link rel="prefetch" href="./assets/js/27.f6c89798.js"><link rel="prefetch" href="./assets/js/28.58938703.js"><link rel="prefetch" href="./assets/js/29.a0b3a5cc.js"><link rel="prefetch" href="./assets/js/30.a7887201.js"><link rel="prefetch" href="./assets/js/31.cbdacff6.js"><link rel="prefetch" href="./assets/js/32.3d4caa9b.js"><link rel="prefetch" href="./assets/js/33.ba141f9f.js"><link rel="prefetch" href="./assets/js/34.7c8b3139.js"><link rel="prefetch" href="./assets/js/35.a9a3dc4c.js"><link rel="prefetch" href="./assets/js/36.1a64f97b.js"><link rel="prefetch" href="./assets/js/37.64bf3a08.js"><link rel="prefetch" href="./assets/js/38.d5a7f7a1.js"><link rel="prefetch" href="./assets/js/39.ee65b755.js"><link rel="prefetch" href="./assets/js/4.69ceb758.js"><link rel="prefetch" href="./assets/js/40.0be61706.js"><link rel="prefetch" href="./assets/js/41.af424b19.js"><link rel="prefetch" href="./assets/js/42.b47a769f.js"><link rel="prefetch" href="./assets/js/43.ed4184d6.js"><link rel="prefetch" href="./assets/js/44.8836396f.js"><link rel="prefetch" href="./assets/js/45.99c1db7a.js"><link rel="prefetch" href="./assets/js/46.2e85c6c4.js"><link rel="prefetch" href="./assets/js/47.48a5bbe5.js"><link rel="prefetch" href="./assets/js/6.6f16a290.js"><link rel="prefetch" href="./assets/js/7.39aba9d0.js"><link rel="prefetch" href="./assets/js/8.abb41df8.js"><link rel="prefetch" href="./assets/js/9.92305a5c.js">
    <link rel="stylesheet" href="./assets/css/0.styles.81cbcbf8.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/./" class="home-link router-link-active"><!----> <span class="site-name">Notebook</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/./dailyRecord/" class="nav-link router-link-active">
  📚学习总结
</a></div><div class="nav-item"><a href="/./bookmark/" class="nav-link">
  📌书签整理
</a></div><div class="nav-item"><a href="/./lint/" class="nav-link">
  ✔️编码规范&amp;协同开发
</a></div><div class="nav-item"><a href="http://shooterblog.site/Learn-JS-Demo/%E5%89%8D%E7%AB%AF%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/index.html" target="_blank" rel="noopener noreferrer" class="nav-link external">
  📖知识脑图
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/./dailyRecord/" class="nav-link router-link-active">
  📚学习总结
</a></div><div class="nav-item"><a href="/./bookmark/" class="nav-link">
  📌书签整理
</a></div><div class="nav-item"><a href="/./lint/" class="nav-link">
  ✔️编码规范&amp;协同开发
</a></div><div class="nav-item"><a href="http://shooterblog.site/Learn-JS-Demo/%E5%89%8D%E7%AB%AF%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/index.html" target="_blank" rel="noopener noreferrer" class="nav-link external">
  📖知识脑图
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>前端模块化和打包工具</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>前端异常监控</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Vue3原理</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Vue3源码</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>内功修炼</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>总结</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/./dailyRecord/2020.html" aria-current="page" class="active sidebar-link">2020 项目经验总结</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/./dailyRecord/2020.html#四标四实人口热力图" class="sidebar-link">四标四实人口热力图</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/./dailyRecord/2020.html#难点-1-百万级的海量数据" class="sidebar-link">难点 1: 百万级的海量数据</a></li><li class="sidebar-sub-header"><a href="/./dailyRecord/2020.html#难点-2-热力图渲染问题" class="sidebar-link">难点 2: 热力图渲染问题</a></li><li class="sidebar-sub-header"><a href="/./dailyRecord/2020.html#效果" class="sidebar-link">效果</a></li></ul></li><li class="sidebar-sub-header"><a href="/./dailyRecord/2020.html#network-analysis" class="sidebar-link">Network Analysis</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/./dailyRecord/2020.html#什么是-network-analysis" class="sidebar-link">什么是 Network Analysis</a></li><li class="sidebar-sub-header"><a href="/./dailyRecord/2020.html#实用场景" class="sidebar-link">实用场景</a></li><li class="sidebar-sub-header"><a href="/./dailyRecord/2020.html#如何实现" class="sidebar-link">如何实现</a></li><li class="sidebar-sub-header"><a href="/./dailyRecord/2020.html#简单demo演示" class="sidebar-link">简单demo演示</a></li></ul></li><li class="sidebar-sub-header"><a href="/./dailyRecord/2020.html#动态图层" class="sidebar-link">动态图层</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/./dailyRecord/2020.html#可以解决什么问题" class="sidebar-link">可以解决什么问题?</a></li><li class="sidebar-sub-header"><a href="/./dailyRecord/2020.html#解决方案" class="sidebar-link">解决方案</a></li><li class="sidebar-sub-header"><a href="/./dailyRecord/2020.html#动态工作空间的使用" class="sidebar-link">动态工作空间的使用</a></li><li class="sidebar-sub-header"><a href="/./dailyRecord/2020.html#代码实现-4-x-版本-api" class="sidebar-link">代码实现(4.X 版本 API)</a></li><li class="sidebar-sub-header"><a href="/./dailyRecord/2020.html#延伸-动态图层的表关联" class="sidebar-link">延伸(动态图层的表关联)</a></li></ul></li><li class="sidebar-sub-header"><a href="/./dailyRecord/2020.html#自动获取-ogc-服务元数据" class="sidebar-link">自动获取 OGC 服务元数据</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/./dailyRecord/2020.html#服务元数据" class="sidebar-link">服务元数据</a></li><li class="sidebar-sub-header"><a href="/./dailyRecord/2020.html#自动获取元数据" class="sidebar-link">自动获取元数据</a></li></ul></li><li class="sidebar-sub-header"><a href="/./dailyRecord/2020.html#arcgis-api-与-echarts-结合" class="sidebar-link">Arcgis api 与 echarts 结合</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/./dailyRecord/2020.html#遇到的问题" class="sidebar-link">遇到的问题</a></li><li class="sidebar-sub-header"><a href="/./dailyRecord/2020.html#解决方案-2" class="sidebar-link">解决方案</a></li><li class="sidebar-sub-header"><a href="/./dailyRecord/2020.html#代码实现" class="sidebar-link">代码实现</a></li></ul></li><li class="sidebar-sub-header"><a href="/./dailyRecord/2020.html#openlayers-与超图平台" class="sidebar-link">openlayers 与超图平台</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/./dailyRecord/2020.html#openlayers-基础入门" class="sidebar-link">openlayers 基础入门</a></li><li class="sidebar-sub-header"><a href="/./dailyRecord/2020.html#项目上使用-openlayers-超图-的经验" class="sidebar-link">项目上使用 openlayers/超图 的经验</a></li></ul></li><li class="sidebar-sub-header"><a href="/./dailyRecord/2020.html#nginx" class="sidebar-link">Nginx</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/./dailyRecord/2020.html#nginx-学习笔记" class="sidebar-link">Nginx 学习笔记</a></li><li class="sidebar-sub-header"><a href="/./dailyRecord/2020.html#正式环境内外网-ip-导致请求失败的问题" class="sidebar-link">正式环境内外网 IP 导致请求失败的问题</a></li><li class="sidebar-sub-header"><a href="/./dailyRecord/2020.html#解决办法" class="sidebar-link">解决办法</a></li></ul></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>GIS</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="_2020-项目经验总结"><a href="#_2020-项目经验总结" class="header-anchor">#</a> 2020 项目经验总结</h1> <p>总结收纳自己过去一年里在项目上遇到的棘手问题以及解决办法</p> <h2 id="四标四实人口热力图"><a href="#四标四实人口热力图" class="header-anchor">#</a> 四标四实人口热力图</h2> <h3 id="难点-1-百万级的海量数据"><a href="#难点-1-百万级的海量数据" class="header-anchor">#</a> 难点 1: 百万级的海量数据</h3> <p>海量数据的热力图渲染,如果不做特殊处理,不管是客户端还是服务器的性能都无法满足</p> <h4 id="第一阶段"><a href="#第一阶段" class="header-anchor">#</a> 第一阶段</h4> <p>既然是海量数据,那么我们就给他来个浓缩,俗话说浓缩就是精华. 所以我们要拿到人口点数据后进行数据抽稀.</p> <p><strong>什么是抽稀?怎么抽稀?</strong></p> <p>就是用格网将地图分割,每个格网内的所有点融合为一个点. 由于是人口数据,抽稀采用总和的方法,即抽稀后的点总人口属性值为格网内所有人口点的人数总和.</p> <p>并且要生成不同比例尺下的抽稀图层. 原因很简单,比如我对一比一百万的比例尺采用了 100 _ 100 的格网进行抽稀,当我地图缩放到一比五十万的时候,如果还是用这个格网生成的抽稀点数据就太稀啦,这时就需要来个 200 _ 200 的格网对一比五百万比例尺下的原始数据再做一次格网抽稀.</p> <p>最后根据地图的比例尺去获取不同格网下生成的抽稀人口数据做热力图渲染.</p> <p>原理图:</p> <p><img src="./assets/img/1.cfba3be5.png" alt="image"></p> <h4 id="第一阶段的效果"><a href="#第一阶段的效果" class="header-anchor">#</a> 第一阶段的效果</h4> <p>可以加载出热力图,并且在一定程度上缓解了原数据大的问题，但是缺点还是太明显，在大比例尺的情况下，如一比四千的时候，抽稀的网格是非常细的，这就导致抽稀完后的数据还是很多点，当前端根据地图范围发出查询请求的时候,接口对大数据量的数据进行空间查询遍历的时候，速度非常慢，这也最终导致接口的响应时间非常长（大比例尺情况下会大于一分钟）。</p> <h4 id="第二阶段"><a href="#第二阶段" class="header-anchor">#</a> 第二阶段</h4> <p>我们都知道地图服务的出图方式有动态出图和切片两种方式,上面说的方法类似动态出图,每次请求都要查询原数据,时间就花在了这个,那我们能不能借鉴切片服务的思想呢?答案是可以!</p> <p>方法很简单,我们设置一个 256 * 256 大小的切片,对每个比例尺下生成的抽稀后点数据进行一次切片预处理(把同一个切片范围内的抽稀点放在一起). 这样,地图范围再发生变化的时候,就可以不用查询抽稀后的数据,而是根据比例尺和范围计算出对应的切片等级和切片行列号,并根据这个,直接拿到对应切片里的已经存放好的数据.</p> <p>样做就可以避免计算接口进行空间查询操作，拿到切片等级和行列号后直接返回对应切片内的抽稀结果，速度上得到极大的改善. 简直就是质的飞跃.</p> <p><img src="./assets/img/2.7022f322.png" alt="image"></p> <p>改善后接口响应时间:</p> <p><img src="./assets/img/3.7a2b0938.png" alt="image"></p> <h3 id="难点-2-热力图渲染问题"><a href="#难点-2-热力图渲染问题" class="header-anchor">#</a> 难点 2: 热力图渲染问题</h3> <h4 id="颜色梯度"><a href="#颜色梯度" class="header-anchor">#</a> 颜色梯度</h4> <p>拿到了数据后,如何才能将热力图的效果做到最好.(各个颜色在地图上面积占比接近,用户有直观的色差对比)</p> <p>这就需要我们动态计算出当前范围获取到的数据最佳热力图颜色梯度.使每个梯度中的点数接近,这样渲染出来的热力图最好看.</p> <p>arcmap 中对设置梯度分级的时候除了常见的手动设置间隔和相等间隔分级外，还给出了几个常用的分级方法:</p> <p><img src="./assets/img/4.9b876edc.png" alt="image"></p> <p>每个方法的特点参考：
http://blog.sina.com.cn/s/blog_663d9a1f0102vdp9.html</p> <p>有了上面的启发,我们可以想到怎么对热力图颜色梯度做控制,最简单的方法就是拿到全部的人口点,对他们的人口数进行排序,排序后按等份切割,每份数据的最大值就是这个颜色梯度的最大值.</p> <p>值得注意的是,每个颜色梯度的梯度差最好保证有最大值的 0.1%,否则可能会因为梯度差太小被忽略.</p> <h4 id="热力点影响范围-blurradius"><a href="#热力点影响范围-blurradius" class="header-anchor">#</a> 热力点影响范围(blurRadius)</h4> <p>blurRadius 是指图层中每个点的影响区域。定义为以像素为单位的半径。默认值为 10，这表示为点位置 10 像素半径内的像素分配了一个强度值，该值对应于它们与附近点的距离。</p> <p><strong>热力图中的颜色是如何计算出来的呢? arcgis API 官网解释如下:</strong></p> <p>由 blurRadius 确定的区域上每个点的影响强度。高斯或正态分布用于散布点的颜色.</p> <p><img src="./assets/img/5.2a7ad6ef.png" alt="image"></p> <blockquote><p>标准正态分布（也称为钟形曲线）用于根据视图中每个像素与一个或多个点的接近程度将强度值应用于视图中的每个像素。在点位置的 blurRadius（默认为 10px）设置的距离内的像素被分配了强度值。点的 1 个标准偏差内的像素的强度值分配为 1。相邻像素的强度值越低，则它们离该点的距离越远。在点影响区域之外的像素的强度值为 0。具有高强度值的像素被分配为强色，而具有低强度值的像素被分配为弱色 ​​。这会产生模糊的影响区域而不是离散点的视觉效果。</p></blockquote> <p>对每个点重复上述过程。每次执行计算时，每个像素的强度值都会基于其与多个点的接近程度而累积。然后，基于分配给每个像素的总体强度值，沿连续的色带对像素进行着色。最后产生一个连续的表面，就是热力图.</p> <p>既然这个 blurRadius 这么关键,那么我们就不得不考虑如何正确设置他的值.</p> <p>在一体化中我是选择了根据比例尺动态设置,原因是在小比例尺下,一个点的影响范围不应太大,极端点里例子就是设太大一个点就把整个城市都覆盖了.同理在大比例下又需要适当加大热力点影响范围.</p> <p>所以先定一个最小比例尺下的 blurRadius 和最大比例尺下的 blurRadius,然后根据实际地图比例尺线型计算出 blurRadius 最合适</p> <h3 id="效果"><a href="#效果" class="header-anchor">#</a> 效果</h3> <p>在不同比例尺下的效果图</p> <p><img src="./assets/img/6.a40d60f3.png" alt="image"></p> <p><img src="./assets/img/7.46e7f384.png" alt="image"></p> <p><img src="./assets/img/8.cb7ea13f.png" alt="image"></p> <h2 id="network-analysis"><a href="#network-analysis" class="header-anchor">#</a> Network Analysis</h2> <h3 id="什么是-network-analysis"><a href="#什么是-network-analysis" class="header-anchor">#</a> 什么是 Network Analysis</h3> <p>网络分析,在GIS领域主要是对道路网络数据进行路径、最近设施点、服务区、位置分配及车辆配送等问题的分析</p> <h3 id="实用场景"><a href="#实用场景" class="header-anchor">#</a> 实用场景</h3> <p>分析设施点的服务范围,如一家医院在根据道路网络分析出2km路程内的服务范围, 而不是简单的缓冲区分析, 更加具有参考价值</p> <p><img src="./assets/img/22.d1ab1359.png" alt="image"></p> <h3 id="如何实现"><a href="#如何实现" class="header-anchor">#</a> 如何实现</h3> <ol><li>创建网络数据集,发布网络分析服务</li></ol> <p>具体如何创建可以参考网上资料:</p> <p>以下是我发布的服务,可以连接公司VPN访问</p> <p>http://192.168.1.136:6080/arcgis/rest/services/YTH/testNAService/NAServer/Service%20Area</p> <ol start="2"><li>使用Network Analysis</li></ol> <p>Network Analysis下有许多分析,如路径分析服务，服务区分析服务，以及最近设施点分析服务</p> <p><img src="./assets/img/23.0dc26be3.png" alt="image"></p> <p>这里先分析我们用到的service Area(服务区分析)</p> <p>用到了&quot;esri/tasks/ServiceAreaTask&quot;, &quot;esri/tasks/ServiceAreaParameters&quot;</p> <p>ServiceAreaTask 顾名思义 服务区任务,我们只需要传入我们的服务url实例化即可</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> serviceAreaTask <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServiceAreaTask</span><span class="token punctuation">(</span><span class="token string">&quot;http://192.168.1.136:6080/arcgis/rest/services/YTH/testNAService/NAServer/Service%20Area&quot;</span><span class="token punctuation">)</span>
</code></pre></div><p>ServiceAreaParameters是指服务区分析的参数,下面介绍主要参数:</p> <table><thead><tr><th style="text-align:left;">名称</th> <th style="text-align:left;">类型</th> <th style="text-align:left;">说明</th></tr></thead> <tbody><tr><td style="text-align:left;">Facilities</td> <td style="text-align:left;">FeatureSet</td> <td style="text-align:left;">设施点集合(可以是多个设施点)</td></tr> <tr><td style="text-align:left;">DefaultBreaks</td> <td style="text-align:left;">Number[]</td> <td style="text-align:left;">中断值,用逗号分割，例如&quot;100,200,300&quot;(假如单位是米),表示搜索设施点100m,200m,300m道路网络范围</td></tr> <tr><td style="text-align:left;">splitPolygonsAtBreaks</td> <td style="text-align:left;">Boolean</td> <td style="text-align:left;">表示从中断处（不同区域等级）拆分多边形，这样可得到不同距离之间到达的区域多边形</td></tr> <tr><td style="text-align:left;">mergeSimilarPolygonRanges</td> <td style="text-align:left;">Boolean</td> <td style="text-align:left;">如果为true，则相同范围将合并。多个设施点共同分析的时候比较有用</td></tr></tbody></table> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> params <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServiceAreaParameters</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">outSpatialReference</span><span class="token operator">:</span> map<span class="token punctuation">.</span>spatialReference<span class="token punctuation">,</span>
  <span class="token literal-property property">returnFacilities</span><span class="token operator">:</span> <span class="token boolean">false</span>  <span class="token comment">// 是否返回设施点</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
params<span class="token punctuation">.</span>splitPolygonsAtBreaks <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span> <span class="token comment">// 返回的服务区是否需要在服务区之间分割</span>
params<span class="token punctuation">.</span>mergeSimilarPolygonRanges <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">// 多个设施点的时候,相同的服务区合并</span>
params<span class="token punctuation">.</span>defaultBreaks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">500</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token number">1500</span><span class="token punctuation">]</span> <span class="token comment">// 500米,1000米,1500米服务区分析 </span>

<span class="token keyword">let</span> facilities <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FeatureSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
facilities<span class="token punctuation">.</span>features <span class="token operator">=</span> features<span class="token punctuation">;</span>

<span class="token keyword">let</span> location1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Graphic</span><span class="token punctuation">(</span>Point<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> location2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Graphic</span><span class="token punctuation">(</span>Point<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> features <span class="token operator">=</span> <span class="token punctuation">[</span>location1<span class="token punctuation">,</span>location2<span class="token punctuation">]</span>

<span class="token comment">// 定义两个设施点执行服务区分析</span>
params<span class="token punctuation">.</span>facilities <span class="token operator">=</span> facilities<span class="token punctuation">;</span>

serviceAreaTask<span class="token punctuation">.</span><span class="token function">solve</span><span class="token punctuation">(</span>params<span class="token punctuation">,</span> <span class="token parameter">solveResult</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>请求server执行服务区分析的地址</p> <div class="language-url extra-class"><pre class="language-url"><code><span class="token scheme">http<span class="token scheme-delimiter">:</span></span><span class="token authority"><span class="token authority-delimiter">//</span><span class="token host"><span class="token ipv4-address">192.168.1.136</span></span><span class="token port-segment"><span class="token port-delimiter">:</span><span class="token port">6080</span></span></span><span class="token path"><span class="token path-separator">/</span>arcgis<span class="token path-separator">/</span>rest<span class="token path-separator">/</span>services<span class="token path-separator">/</span>YTH<span class="token path-separator">/</span>testNAService<span class="token path-separator">/</span>NAServer<span class="token path-separator">/</span>Service%20Area<span class="token path-separator">/</span>solveServiceArea</span><span class="token query"><span class="token query-delimiter">?</span><span class="token pair"><span class="token key">mergeSimilarPolygonRanges</span>=<span class="token value">true</span></span><span class="token pair-delimiter">&amp;</span><span class="token pair"><span class="token key">facilities</span>=<span class="token value">%7B%22type%22%3A%22features%22%2C%22features%22%3A%5B%7B%22geometry%22%3A%7B%22x%22%3A114.92063100725365%2C%22y%22%3A25.854150619326397%2C%22spatialReference%22%3A%7B%22wkid%22%3A4326%2C%22latestWkid%22%3A4326%7D%7D%7D%2C%7B%22geometry%22%3A%7B%22x%22%3A114.93800227674987%2C%22y%22%3A25.85223683539885%2C%22spatialReference%22%3A%7B%22wkid%22%3A4326%2C%22latestWkid%22%3A4326%7D%7D%7D%5D%2C%22doNotLocateOnRestrictedElements%22%3Atrue%7D</span></span></span>
</code></pre></div><p>返回结果,可以看到返回了三个服务区的geometry</p> <p><img src="./assets/img/24.ce342a7a.png" alt="image"></p> <h3 id="简单demo演示"><a href="#简单demo演示" class="header-anchor">#</a> 简单demo演示</h3> <p>在道路样例数据地图上选择两个点进行服务区分析,得到结果如下</p> <p>蓝色是0-500m的区间,绿色是500m-1000m区间,红色是1000m-1500m区间</p> <p><img src="./assets/img/25.8792d518.png" alt="image"></p> <h2 id="动态图层"><a href="#动态图层" class="header-anchor">#</a> 动态图层</h2> <p>地图服务发布到 ArcGIS Server 站点后，可根据需要选择是否允许服务器的客户端（如 ArcGIS web API）动态更改地图服务中的图层外观和行为。要确定哪些图层显示在地图中、图层符号系统、图层顺序和位置以及标注等，可通过使用动态图层在服务器端实现。这种方式下，动态图层可有效增加用户与地图的交互。</p> <p>上面是官方的介绍,这里补充一下,动态图层不单单可以操作已发布为服务的图层,还可以把 GDB,MDB,SHP,raster 类型的本地文件当成服务来加载.</p> <h3 id="可以解决什么问题"><a href="#可以解决什么问题" class="header-anchor">#</a> 可以解决什么问题?</h3> <p>广州一体化有一个需求是将空间校正后的图片添加到地图上,使用动态图层可以完美解决. 不单只是图片,一体化在之前已经使用动态图层加载 GDB 和 SHP 数据了.</p> <h3 id="解决方案"><a href="#解决方案" class="header-anchor">#</a> 解决方案</h3> <p>如上面说的,动态图层可以把我们服务器上的文件当成服务来加载,前提是配置动态工作空间</p> <p>在项目中,采用动态图层加载动态工作空间里的文件方案来加载 GDB 和 SHP 会多一些.其实他也可以加载 raster 类型的文件(栅格图片),甚至可以获取表数据关联到服务的要素上,给要素扩展属性.</p> <h3 id="动态工作空间的使用"><a href="#动态工作空间的使用" class="header-anchor">#</a> 动态工作空间的使用</h3> <h4 id="配置"><a href="#配置" class="header-anchor">#</a> 配置</h4> <p>登录 arcgis server 打开对应的 mapserver 管理页面,开启并添加动态工作空间.</p> <p><img src="./assets/img/9.3cd47057.png" alt="image"></p> <p>添加动态工作空间,可以选择 GDB(企业级数据库), MDB(文件地理数据库), 栅格文件夹(jpg|png|tif 等栅格图片), shapefile 文件夹(shp 文件)</p> <p><img src="./assets/img/10.b6dee7ba.png" alt="image"></p> <p>对应路径下放入图片文件</p> <p><img src="./assets/img/11.f2adad2b.png" alt="image"></p> <h4 id="测试使用"><a href="#测试使用" class="header-anchor">#</a> 测试使用</h4> <p>打开 mapserver 页面,例如:</p> <p>http://xxxx:xx/arcgis/rest/services/GZ_DynamicLayer/MapServer</p> <p>找到 Child Resources 下的动态图层</p> <p><img src="./assets/img/12.0680d9c7.png" alt="image"></p> <p>打开后传入参数(以 raster 动态工作空间为例,读取到 MyImageWorkspaceID 空间下的 03061002.jpg)</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;id&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token property">&quot;source&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;dataSource&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;workspaceId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;MyImageWorkspaceID&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 配置动态工作空间的ID</span>
      <span class="token property">&quot;dataSourceName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;03061002.jpg&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 动态空间文件夹下的图片文件名</span>
      <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;raster&quot;</span> <span class="token comment">// 栅格类型数据</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;dataLayer&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>那么这时 server 已经动态生成了一个 raster Layer 的图层可供前端加载</p> <p><img src="./assets/img/13.edb2357a.png" alt="image"></p> <p>最后,通过 arcgis server 提供的 export map 接口,生成图片</p> <p><img src="./assets/img/14.51221c06.png" alt="image"></p> <p><img src="./assets/img/15.6897552a.png" alt="image"></p> <p>这样就能将服务器上的图片做为服务资源加载,以上是以图片为例, shp 和 gdb 同样适用.</p> <h3 id="代码实现-4-x-版本-api"><a href="#代码实现-4-x-版本-api" class="header-anchor">#</a> 代码实现(4.X 版本 API)</h3> <p>因为新的项目不会再用 3.x 的 api,所以这里以 4.x 版本的 api 为例,3.x 也可以实现,原理相同.</p> <h4 id="以-featurelayer-来加载"><a href="#以-featurelayer-来加载" class="header-anchor">#</a> 以 featureLayer 来加载</h4> <p>加载 GDB 的要素类为例</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> featureLayer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FeatureLayer</span><span class="token punctuation">(</span>
  <span class="token string">&quot;http://172.30.239.201:6080/arcgis/rest/services/GZ_DynamicLayer/MapServer/dynamicLayer&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    renderer<span class="token punctuation">,</span>
    <span class="token literal-property property">dynamicDataSource</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&quot;data-layer&quot;</span><span class="token punctuation">,</span>
      <span class="token literal-property property">dataSource</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&quot;table&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 如果是图片要换成raster类型</span>
        <span class="token literal-property property">workspaceId</span><span class="token operator">:</span> <span class="token string">&quot;MyFileGDBWorkspaceID&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 配置动态工作空间的ID</span>
        <span class="token literal-property property">dataSourceName</span><span class="token operator">:</span> <span class="token string">&quot;Polygon2101121619254669&quot;</span> <span class="token comment">// GDB下的要素类名称</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="以-mapimagelayer-来加载"><a href="#以-mapimagelayer-来加载" class="header-anchor">#</a> 以 MapImageLayer 来加载</h4> <p>以 MapImageLayer 加载,不单单要设置动态工作空间文件,还要给上 renderer 渲染器,否则会不渲染图形</p> <p>加载 SHP 为例</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> sublayer <span class="token operator">=</span> <span class="token punctuation">{</span>
  renderer<span class="token punctuation">,</span>
  <span class="token literal-property property">opacity</span><span class="token operator">:</span> <span class="token number">0.75</span><span class="token punctuation">,</span>
  <span class="token literal-property property">source</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&quot;data-layer&quot;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">dataSource</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&quot;table&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 如果是图片要换成raster类型</span>
      <span class="token literal-property property">workspaceId</span><span class="token operator">:</span> <span class="token string">&quot;MyShapefileWorkspaceID&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 配置动态工作空间的ID</span>
      <span class="token literal-property property">dataSourceName</span><span class="token operator">:</span> <span class="token string">&quot;inter.shp&quot;</span> <span class="token comment">// 工作空间文件夹下的SHP文件名称</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
sublayers<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>sublayer<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> dynamicLayer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MapImageLayer</span><span class="token punctuation">(</span>
  <span class="token string">&quot;http://172.30.239.201:6080/arcgis/rest/services/GZ_DynamicLayer/MapServer&quot;</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
dynamicLayer<span class="token punctuation">.</span>sublayers <span class="token operator">=</span> sublayers<span class="token punctuation">;</span>
</code></pre></div><h3 id="延伸-动态图层的表关联"><a href="#延伸-动态图层的表关联" class="header-anchor">#</a> 延伸(动态图层的表关联)</h3> <p>除了添加几何图形或图片到地图上,动态工作空间还支持把表数据关联到服务上</p> <h4 id="数据准备"><a href="#数据准备" class="header-anchor">#</a> 数据准备</h4> <p>在 GDB 中新建一个 table,增加一个关联用的字段 XZQH(这个字段将会和别的图层表做表关联),这里写了一个天河区,将会和后面举例的图层中行政区名字段做关联</p> <p><img src="./assets/img/16.c8a02f00.png" alt="image"></p> <p>打开需要关联的服务图层,开启动态工作空间并配置,这里不再赘述</p> <p>找到对应的关联字段</p> <p><img src="./assets/img/17.ad2c8865.png" alt="image"></p> <h4 id="代码实现并检验"><a href="#代码实现并检验" class="header-anchor">#</a> 代码实现并检验</h4> <p>新建一个 featureLayer,因为 featureLayer 是查询到要素再加载到地图上,可以查看到要素的属性,如果换成的话,只能拿到一张图片,无法知道属性是否已关联到我们新建的表.</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> featureLayer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FeatureLayer</span><span class="token punctuation">(</span>
  <span class="token string">&quot;http://172.30.239.201:6080/arcgis/rest/services/Test/test_XZQH/MapServer/dynamicLayer&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    renderer<span class="token punctuation">,</span>
    <span class="token literal-property property">outFields</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;*&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">dynamicDataSource</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token comment">// 动态数据层</span>
      <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&quot;data-layer&quot;</span><span class="token punctuation">,</span>
      <span class="token literal-property property">dataSource</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&quot;join-table&quot;</span><span class="token punctuation">,</span>
        <span class="token comment">// 定义一个左源表,类型是&quot;map-layer&quot;表示服务里的图层</span>
        <span class="token comment">// mapLayerId是服务对应的图层下标</span>
        <span class="token literal-property property">leftTableSource</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&quot;map-layer&quot;</span><span class="token punctuation">,</span>
          <span class="token literal-property property">mapLayerId</span><span class="token operator">:</span> <span class="token number">3</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token comment">// 定义右源表,这里把我们要关联上的table放进来</span>
        <span class="token literal-property property">rightTableSource</span><span class="token operator">:</span> <span class="token punctuation">{</span>
          <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&quot;data-layer&quot;</span><span class="token punctuation">,</span>
          <span class="token literal-property property">dataSource</span><span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&quot;table&quot;</span><span class="token punctuation">,</span>
            <span class="token literal-property property">workspaceId</span><span class="token operator">:</span> <span class="token string">&quot;MyFileGDBWorkspaceID&quot;</span><span class="token punctuation">,</span>
            <span class="token literal-property property">dataSourceName</span><span class="token operator">:</span> <span class="token string">&quot;tableTest&quot;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token comment">// 定义两个表的关联字段</span>
        <span class="token literal-property property">leftTableKey</span><span class="token operator">:</span> <span class="token string">&quot;QM&quot;</span><span class="token punctuation">,</span>
        <span class="token literal-property property">rightTableKey</span><span class="token operator">:</span> <span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span>
        <span class="token comment">// 左内联还是左外联</span>
        <span class="token literal-property property">joinType</span><span class="token operator">:</span> <span class="token string">&quot;left-outer-join&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>完成后加载 featureLayer,查看网络请求</p> <p><img src="./assets/img/18.0851149b.png" alt="image"></p> <p>可以看到,我们的 tableTest 表的数据被关联进来了,如果关联字段匹配,就会把字段填值填入,否则为 null</p> <p>上面例子中的右源表除了是 table,也可以是 shp 或者是 GDB 下的要素类,效果一样</p> <h2 id="自动获取-ogc-服务元数据"><a href="#自动获取-ogc-服务元数据" class="header-anchor">#</a> 自动获取 OGC 服务元数据</h2> <p>OGC 服务包括 WMS,WMTS,WFS,WCS,其中在我们项目中比较容易接触到的是 WMS(web map server)和 WMTS(web map tile server). OGC 服务如何使用也成为了必须掌握的技能.</p> <h3 id="服务元数据"><a href="#服务元数据" class="header-anchor">#</a> 服务元数据</h3> <p>OGC 服务的服务元数据都会存放在 GetCapabilities 接口下,里面有图层信息,切片信息(切片等级,比例尺,切片原点),出图类型(jpg|png),坐标信息</p> <p>以天地图为例</p> <p>http://t0.tianditu.gov.cn/vec_c/wmts?tk=5d4236a2a06043cd0b0880bbf270c958&amp;Request=GetCapabilities&amp;Service=WMTS</p> <p>加载服务需要的参数如下,所有信息都可以在里面拿到</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> mateData <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">style</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>  <span class="token comment">// 服务样式</span>
    <span class="token literal-property property">layer</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>  <span class="token comment">// 图层名称</span>
    <span class="token literal-property property">format</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token comment">//图像格式</span>
    <span class="token literal-property property">matrixSet</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 切片矩阵名</span>
    <span class="token literal-property property">tileGrid</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">origin</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">x</span><span class="token operator">:</span> <span class="token punctuation">,</span> <span class="token literal-property property">y</span><span class="token operator">:</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token comment">// 切片原点</span>
      <span class="token literal-property property">tileSize</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>        <span class="token comment">// 切片大小</span>
      <span class="token literal-property property">resolutions</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>     <span class="token comment">// 切片分辨率</span>
      <span class="token literal-property property">matrixIds</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>        <span class="token comment">// 切片矩阵IDs</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>arcgis API 对加载 OGC 服务会先获取到服务元数据,解析后再加载.</p> <p>openlayers 中没有对应的代码,新建一个 OGC 图层的时候,要手动去查服务元数据,写到配置文件中.当加载 OGC 服务的时候就读取配置文件加载.</p> <p>考虑到 arcgis API 可以实现自动获取服务信息,那我们也可以在 openlayers 上实现</p> <h3 id="自动获取元数据"><a href="#自动获取元数据" class="header-anchor">#</a> 自动获取元数据</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// GetCapabilities获取到服务元数据，返回的是xml格式</span>
<span class="token keyword">const</span> data <span class="token operator">=</span> <span class="token keyword">await</span> axios<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>
  <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>url<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>
    url<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">&quot;?&quot;</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">?</span> <span class="token string">&quot;&amp;&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;?&quot;</span>
  <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">service=WMTS&amp;request=GetCapabilities</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token literal-property property">responseType</span><span class="token operator">:</span> <span class="token string">&quot;xml&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> mateDataXML <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DOMParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parseFromString</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token string">&quot;text/xml&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> contentsXML <span class="token operator">=</span> mateDataXML<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">&quot;Contents&quot;</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// 通过getElementsByTagName把需要的信息全部拿下后加载图层</span>
</code></pre></div><p>这部分内容在新一张图中的 eyemap 库已实现</p> <h2 id="arcgis-api-与-echarts-结合"><a href="#arcgis-api-与-echarts-结合" class="header-anchor">#</a> Arcgis api 与 echarts 结合</h2> <h3 id="遇到的问题"><a href="#遇到的问题" class="header-anchor">#</a> 遇到的问题</h3> <p>需要在地图上展示图表,但是 arcgis API 并没有相关支持, echarts 官网也只是提供了迁徙图的解决方案,没有饼状图柱状图等常用图表与 arcgis API 结合</p> <h3 id="解决方案-2"><a href="#解决方案-2" class="header-anchor">#</a> 解决方案</h3> <p>从 echarts 官方提供 demo 入手,既然他可以支持迁徙图,那我们稍加改造,支持饼状图柱状图应该问题不大.</p> <h3 id="代码实现"><a href="#代码实现" class="header-anchor">#</a> 代码实现</h3> <h4 id="创建图表的-dom-元素"><a href="#创建图表的-dom-元素" class="header-anchor">#</a> 创建图表的 DOM 元素</h4> <p>创建一个工具类,首先第一步我们需要创建一个和地图一样大小的 DOM 元素用来加载图表,并且挂载在地图 DOM 元素下</p> <p>工具类的构造函数如下,三个参数分别为需要添加图表的地图对象,echarts 包,和图表的 DOM 元素 ID</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function-variable function">constructor</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">map<span class="token punctuation">,</span> chart<span class="token punctuation">,</span> chartId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> n <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span>chartId<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>n <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 创建DOM元素</span>
    n <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;div&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    n<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span> chartId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    n<span class="token punctuation">.</span>style<span class="token punctuation">.</span>position <span class="token operator">=</span> <span class="token string">&quot;absolute&quot;</span><span class="token punctuation">;</span>
    n<span class="token punctuation">.</span>style<span class="token punctuation">.</span>height <span class="token operator">=</span> map<span class="token punctuation">.</span>height <span class="token operator">+</span> <span class="token string">&quot;px&quot;</span><span class="token punctuation">;</span>
    n<span class="token punctuation">.</span>style<span class="token punctuation">.</span>width <span class="token operator">=</span> map<span class="token punctuation">.</span>width <span class="token operator">+</span> <span class="token string">&quot;px&quot;</span><span class="token punctuation">;</span>
    n<span class="token punctuation">.</span>style<span class="token punctuation">.</span>top <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    n<span class="token punctuation">.</span>style<span class="token punctuation">.</span>left <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">// 和地图DOM元素一样大小并挂载到map对象下</span>
    map<span class="token punctuation">.</span>__container<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>n<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_echartsContainer <span class="token operator">=</span> n<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_map <span class="token operator">=</span> map<span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>chart <span class="token operator">=</span> chart<span class="token punctuation">;</span>

  <span class="token comment">// 基于准备好的dom，初始化echarts实例</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_ec <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>chart<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_echartsContainer<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 绑定地图事件,后面会提及</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_bindEvent</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="定义图表的地理坐标-转为屏幕坐标加载"><a href="#定义图表的地理坐标-转为屏幕坐标加载" class="header-anchor">#</a> 定义图表的地理坐标,转为屏幕坐标加载</h4> <p>配置图表数据,包括地理坐标,配置信息如下:</p> <div class="language-json extra-class"><pre class="language-json"><code>options <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
  <span class="token comment">// 重点在这个grid里,我们自定义了lat,lon经纬度 其他参数查阅echarts官网</span>
  <span class="token property">&quot;grid&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> <span class="token property">&quot;lat&quot;</span><span class="token operator">:</span> <span class="token number">120</span><span class="token punctuation">,</span> <span class="token property">&quot;lon&quot;</span><span class="token operator">:</span> <span class="token number">22.5</span><span class="token punctuation">,</span> <span class="token property">&quot;width&quot;</span><span class="token operator">:</span> <span class="token string">&quot;30px&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;height&quot;</span><span class="token operator">:</span> <span class="token string">&quot;30px&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;tooltip&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;trigger&quot;</span><span class="token operator">:</span> <span class="token string">&quot;axis&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;axisPointer&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;shadow&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;xAxis&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;gridIndex&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;category&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;data&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;Mon&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Tue&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Wed&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Thu&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Fri&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Sat&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Sun&quot;</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;yAxis&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> <span class="token property">&quot;gridIndex&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;value&quot;</span><span class="token punctuation">,</span> <span class="token property">&quot;show&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;series&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Test&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;bar&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;xAxisIndex&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token property">&quot;yAxisIndex&quot;</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
      <span class="token property">&quot;data&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">120</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">,</span> <span class="token number">150</span><span class="token punctuation">,</span> <span class="token number">80</span><span class="token punctuation">,</span> <span class="token number">70</span><span class="token punctuation">,</span> <span class="token number">110</span><span class="token punctuation">,</span> <span class="token number">130</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">]</span>
</code></pre></div><p>工具类中定义处理数据的函数,并调用 echarts 库的 setOption 函数生成图表</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function-variable function">setOption</span> <span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  options<span class="token punctuation">.</span>grid<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">grid<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> point <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Point</span><span class="token punctuation">(</span>grid<span class="token punctuation">.</span>lon<span class="token punctuation">,</span> grid<span class="token punctuation">.</span>lat<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_map<span class="token punctuation">.</span><span class="token function">toScreen</span><span class="token punctuation">(</span>point<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 得到了坐标点对应的屏幕点</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&amp;&amp;</span> i<span class="token punctuation">.</span>x <span class="token operator">&amp;&amp;</span> i<span class="token punctuation">.</span>y<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token punctuation">(</span>grid<span class="token punctuation">.</span>x <span class="token operator">=</span> i<span class="token punctuation">.</span>x <span class="token operator">+</span> <span class="token string">&quot;px&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>grid<span class="token punctuation">.</span>y <span class="token operator">=</span> i<span class="token punctuation">.</span>y <span class="token operator">+</span> <span class="token string">&quot;px&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>option<span class="token punctuation">.</span>series<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>type <span class="token operator">==</span> <span class="token string">&quot;pie&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        e<span class="token punctuation">.</span>series<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">.</span>center <span class="token operator">=</span> <span class="token punctuation">[</span>i<span class="token punctuation">.</span>x<span class="token punctuation">,</span> i<span class="token punctuation">.</span>y<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  
  <span class="token keyword">this</span><span class="token punctuation">.</span>_options <span class="token operator">=</span> options<span class="token punctuation">;</span>
  <span class="token comment">// 转换为屏幕点后就可以调用echarts库,生成图表</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_ec<span class="token punctuation">.</span><span class="token function">setOption</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="交互优化"><a href="#交互优化" class="header-anchor">#</a> 交互优化</h4> <p>目前已经做到了在地图对应的坐标点中生成图表,那么当地图发生变化时,图表也要响应跟着变化</p> <p>上面提到的 bindEvent 函数就起作用了</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function-variable function">_resize</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setOption</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_options<span class="token punctuation">)</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_ec<span class="token punctuation">.</span><span class="token function">resize</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token function-variable function">_bindEvent</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 如果是4.x的api直接监听extent属性即可</span>
  <span class="token comment">// 3.x需要监听缩放和平移</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>handler <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token comment">// 地图发生缩放的时候,先隐藏图表,缩放完成后再重新渲染图表</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_map<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;zoom-start&quot;</span><span class="token punctuation">,</span> lang<span class="token punctuation">.</span><span class="token function">hitch</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_echartsContainer<span class="token punctuation">.</span>style<span class="token punctuation">.</span>visibility <span class="token operator">=</span> <span class="token string">&quot;hidden&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_map<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;zoom-end&quot;</span><span class="token punctuation">,</span> lang<span class="token punctuation">.</span><span class="token function">hitch</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_resize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>_echartsContainer<span class="token punctuation">.</span>style<span class="token punctuation">.</span>visibility <span class="token operator">=</span> <span class="token string">&quot;visible&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">// 同理地图拖拽的时候也一样</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_map<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;pan&quot;</span><span class="token punctuation">,</span>lang<span class="token punctuation">.</span><span class="token function">hitch</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span>  <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_echartsContainer<span class="token punctuation">.</span>style<span class="token punctuation">.</span>visibility <span class="token operator">=</span> <span class="token string">&quot;hidden&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_map<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;pan-end&quot;</span><span class="token punctuation">,</span>lang<span class="token punctuation">.</span><span class="token function">hitch</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span>  <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_resize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_echartsContainer<span class="token punctuation">.</span>style<span class="token punctuation">.</span>visibility <span class="token operator">=</span> <span class="token string">&quot;visible&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="销毁事件"><a href="#销毁事件" class="header-anchor">#</a> 销毁事件</h4> <p>如果不再需要显示图表了,销毁监听事件</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function-variable function">unBindEvent</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>handler<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      item<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>handler <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="效果展示"><a href="#效果展示" class="header-anchor">#</a> 效果展示</h4> <p><img src="./assets/img/21.67b1373f.png" alt="image"></p> <h2 id="openlayers-与超图平台"><a href="#openlayers-与超图平台" class="header-anchor">#</a> openlayers 与超图平台</h2> <h3 id="openlayers-基础入门"><a href="#openlayers-基础入门" class="header-anchor">#</a> openlayers 基础入门</h3> <p>https://roman-29.github.io/Blog/dailyRecord/OpenLayers.html</p> <h3 id="项目上使用-openlayers-超图-的经验"><a href="#项目上使用-openlayers-超图-的经验" class="header-anchor">#</a> 项目上使用 openlayers/超图 的经验</h3> <p>http://52.83.238.168:9000/ks/doc-project-summary/%E5%9F%BA%E7%A1%80%E4%BF%A1%E6%81%AF%E5%B9%B3%E5%8F%B0/%E9%98%B3%E6%B1%9F.html</p> <h4 id=""><a href="#" class="header-anchor">#</a></h4> <h2 id="nginx"><a href="#nginx" class="header-anchor">#</a> Nginx</h2> <p>Nginx 代理转发可以解决跨域和内外网 IP 造成的问题</p> <h3 id="nginx-学习笔记"><a href="#nginx-学习笔记" class="header-anchor">#</a> Nginx 学习笔记</h3> <p>https://roman-29.github.io/Blog/dailyRecord/Nginx.html</p> <p>或者</p> <p>https://www.yuque.com/docs/share/509b5c01-5b43-4684-8f1f-a6224a10b919?#%20%E3%80%8ANginx%E5%85%A5%E9%97%A8%E3%80%8B</p> <h3 id="正式环境内外网-ip-导致请求失败的问题"><a href="#正式环境内外网-ip-导致请求失败的问题" class="header-anchor">#</a> 正式环境内外网 IP 导致请求失败的问题</h3> <h4 id="问题分析"><a href="#问题分析" class="header-anchor">#</a> 问题分析</h4> <p>超图 iserver 是可以通过一定的规则拼接 url 实现调取图例的图片，例如在服务：
http://52.83.214.66:8090/iserver/services/map-XZQHJX/rest/maps/XZQH/layers/XZQH.html</p> <p>可以访问下面的 url 获取 XZQH_SJXZQH 图层的图例
http://52.83.214.66:8090/iserver/services/map-XZQHJX/rest/maps/XZQH/layers/XZQH_SJXZQH@yjdata@@XZQH/legend</p> <p>这个地址可以看成是 iserver 对外提供的一个接口，其最终会根据请求地址查找到 iserver tomcat 下的静态图片文件并返回给前端。
比如在我电脑的 iserver，图例的静态文件：</p> <p><img src="./assets/img/19.aed6bd51.png" alt="image"></p> <p>现场网络情况是政务外网只能通过外网 IP 访问服务器的 iserver，但是服务器访问自身是需要内网 IP。</p> <p>这就会导致我在用外网 IP 请求 isrever 的图例接口，可以访问成功，但是 iserver 根据我的请求获取 tomcat 下的静态图片文件也是用了外网 IP，导致无法访问。</p> <p><img src="./assets/img/20.4f93b706.png" alt="image"></p> <p>但是我又不能直接用内网 IP 请求 isrever 的图例接口，因为网络环境的原因，在外网是无法使用内网 IP 发送请求的。</p> <h3 id="解决办法"><a href="#解决办法" class="header-anchor">#</a> 解决办法</h3> <p>在服务器上配置 Nginx 做转发,在客户机上使用外网 IP 访问服务器的 Nginx 端口，通过 Nginx 反向代理转发，在服务器上转发为使用内网 IP 访问服务器上的图例，问题解决。</p> <div class="language-txt extra-class"><pre class="language-txt"><code>server {
  listen       8091;
  server_name  localhost;

  # 匹配到iserver就做转发

	location ^~ /iserver/
  {
	  proxy_pass http://内网IP:端口;
  }
}
</code></pre></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">1/20/2021, 9:43:15 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/./dailyRecord/TypeScript.html" class="prev">
        TypeScript
      </a></span> <span class="next"><a href="/./dailyRecord/OpenLayers.html">
        OpenLayers 基础
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="./assets/js/app.09835454.js" defer></script><script src="./assets/js/3.9a8cb714.js" defer></script><script src="./assets/js/5.2b9a4ed4.js" defer></script>
  </body>
</html>
