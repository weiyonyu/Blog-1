<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>äº”ã€diff æ›´æ–°ç®—æ³• | Notebook</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="">
    <meta name="description" content="ğŸ“æ¯å¤©è®°å½•ä¸€ç‚¹ç‚¹">
    
    <link rel="preload" href="./assets/css/0.styles.81cbcbf8.css" as="style"><link rel="preload" href="./assets/js/app.78793606.js" as="script"><link rel="preload" href="./assets/js/3.9a8cb714.js" as="script"><link rel="preload" href="./assets/js/12.f69c7e94.js" as="script"><link rel="prefetch" href="./assets/js/10.3f7afedc.js"><link rel="prefetch" href="./assets/js/11.849f2ab3.js"><link rel="prefetch" href="./assets/js/13.ab50e66a.js"><link rel="prefetch" href="./assets/js/14.4b2fce32.js"><link rel="prefetch" href="./assets/js/15.8b353502.js"><link rel="prefetch" href="./assets/js/16.3195875f.js"><link rel="prefetch" href="./assets/js/17.7a89769a.js"><link rel="prefetch" href="./assets/js/18.fcadf835.js"><link rel="prefetch" href="./assets/js/19.231d3618.js"><link rel="prefetch" href="./assets/js/2.56707d7e.js"><link rel="prefetch" href="./assets/js/20.a85f560c.js"><link rel="prefetch" href="./assets/js/21.24336449.js"><link rel="prefetch" href="./assets/js/22.73659552.js"><link rel="prefetch" href="./assets/js/23.a091243a.js"><link rel="prefetch" href="./assets/js/24.c8ba16f0.js"><link rel="prefetch" href="./assets/js/25.882bb768.js"><link rel="prefetch" href="./assets/js/26.f04079ce.js"><link rel="prefetch" href="./assets/js/27.3ccd410f.js"><link rel="prefetch" href="./assets/js/28.58938703.js"><link rel="prefetch" href="./assets/js/29.a0b3a5cc.js"><link rel="prefetch" href="./assets/js/30.054f5cc9.js"><link rel="prefetch" href="./assets/js/31.2a2497ca.js"><link rel="prefetch" href="./assets/js/32.2fec2015.js"><link rel="prefetch" href="./assets/js/33.1c38360d.js"><link rel="prefetch" href="./assets/js/34.c6f368f7.js"><link rel="prefetch" href="./assets/js/35.eb21b972.js"><link rel="prefetch" href="./assets/js/36.d24643c3.js"><link rel="prefetch" href="./assets/js/37.64bf3a08.js"><link rel="prefetch" href="./assets/js/38.9456e466.js"><link rel="prefetch" href="./assets/js/39.d6639e8e.js"><link rel="prefetch" href="./assets/js/4.3e5912c4.js"><link rel="prefetch" href="./assets/js/40.0be61706.js"><link rel="prefetch" href="./assets/js/41.83d228f2.js"><link rel="prefetch" href="./assets/js/42.4a8c6e1b.js"><link rel="prefetch" href="./assets/js/43.ed4184d6.js"><link rel="prefetch" href="./assets/js/44.84f96688.js"><link rel="prefetch" href="./assets/js/45.99c1db7a.js"><link rel="prefetch" href="./assets/js/46.38462d37.js"><link rel="prefetch" href="./assets/js/47.18ad8970.js"><link rel="prefetch" href="./assets/js/5.07eb40e3.js"><link rel="prefetch" href="./assets/js/6.be2121ec.js"><link rel="prefetch" href="./assets/js/7.198c5ca7.js"><link rel="prefetch" href="./assets/js/8.0d657d1b.js"><link rel="prefetch" href="./assets/js/9.35e5878d.js">
    <link rel="stylesheet" href="./assets/css/0.styles.81cbcbf8.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/./" class="home-link router-link-active"><!----> <span class="site-name">Notebook</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/./dailyRecord/" class="nav-link router-link-active">
  ğŸ“šå­¦ä¹ æ€»ç»“
</a></div><div class="nav-item"><a href="/./bookmark/" class="nav-link">
  ğŸ“Œä¹¦ç­¾æ•´ç†
</a></div><div class="nav-item"><a href="/./lint/" class="nav-link">
  âœ”ï¸ç¼–ç è§„èŒƒ&amp;ååŒå¼€å‘
</a></div><div class="nav-item"><a href="http://shooterblog.site/Learn-JS-Demo/%E5%89%8D%E7%AB%AF%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/index.html" target="_blank" rel="noopener noreferrer" class="nav-link external">
  ğŸ“–çŸ¥è¯†è„‘å›¾
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/./dailyRecord/" class="nav-link router-link-active">
  ğŸ“šå­¦ä¹ æ€»ç»“
</a></div><div class="nav-item"><a href="/./bookmark/" class="nav-link">
  ğŸ“Œä¹¦ç­¾æ•´ç†
</a></div><div class="nav-item"><a href="/./lint/" class="nav-link">
  âœ”ï¸ç¼–ç è§„èŒƒ&amp;ååŒå¼€å‘
</a></div><div class="nav-item"><a href="http://shooterblog.site/Learn-JS-Demo/%E5%89%8D%E7%AB%AF%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/index.html" target="_blank" rel="noopener noreferrer" class="nav-link external">
  ğŸ“–çŸ¥è¯†è„‘å›¾
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>å‰ç«¯æ¨¡å—åŒ–å’Œæ‰“åŒ…å·¥å…·</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>å‰ç«¯å¼‚å¸¸ç›‘æ§</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Vue3åŸç†</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Vue3æºç </span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/./dailyRecord/VUE3-reactivity-core.html" class="sidebar-link">ä¸€ã€å“åº”å¼æ ¸å¿ƒ(ä¾èµ–æ”¶é›†å’Œè§¦å‘)</a></li><li><a href="/./dailyRecord/VUE3-reactivity-advance.html" class="sidebar-link">äºŒã€å“åº”å¼è¿›é˜¶(å“åº”å¼ API)</a></li><li><a href="/./dailyRecord/VUE3-runtime-core.html" class="sidebar-link">ä¸‰ã€è¿è¡Œæ—¶æ ¸å¿ƒ</a></li><li><a href="/./dailyRecord/VUE3-runtime-update.html" class="sidebar-link">å››ã€è¿è¡Œæ—¶æ›´æ–°</a></li><li><a href="/./dailyRecord/VUE3-runtime-diff.html" aria-current="page" class="active sidebar-link">äº”ã€diff æ›´æ–°ç®—æ³•</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/./dailyRecord/VUE3-runtime-diff.html#åŒç«¯å¯¹æ¯”" class="sidebar-link">åŒç«¯å¯¹æ¯”</a></li><li class="sidebar-sub-header"><a href="/./dailyRecord/VUE3-runtime-diff.html#å¯¹æ¯”åŸåˆ™" class="sidebar-link">å¯¹æ¯”åŸåˆ™</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/./dailyRecord/VUE3-runtime-diff.html#ç®€ä»‹" class="sidebar-link">ç®€ä»‹</a></li><li class="sidebar-sub-header"><a href="/./dailyRecord/VUE3-runtime-diff.html#ä»£ç " class="sidebar-link">ä»£ç </a></li></ul></li><li class="sidebar-sub-header"><a href="/./dailyRecord/VUE3-runtime-diff.html#åˆ¤æ–­å·¦ä¾§-å³ä¾§ç›¸ä¼¼èŠ‚ç‚¹" class="sidebar-link">åˆ¤æ–­å·¦ä¾§/å³ä¾§ç›¸ä¼¼èŠ‚ç‚¹</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/./dailyRecord/VUE3-runtime-diff.html#ç®€ä»‹-2" class="sidebar-link">ç®€ä»‹</a></li><li class="sidebar-sub-header"><a href="/./dailyRecord/VUE3-runtime-diff.html#ä»£ç -2" class="sidebar-link">ä»£ç </a></li></ul></li><li class="sidebar-sub-header"><a href="/./dailyRecord/VUE3-runtime-diff.html#åˆ›å»ºæ–°èŠ‚ç‚¹" class="sidebar-link">åˆ›å»ºæ–°èŠ‚ç‚¹</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/./dailyRecord/VUE3-runtime-diff.html#ç®€ä»‹-3" class="sidebar-link">ç®€ä»‹</a></li><li class="sidebar-sub-header"><a href="/./dailyRecord/VUE3-runtime-diff.html#åˆ›å»º" class="sidebar-link">åˆ›å»º</a></li><li class="sidebar-sub-header"><a href="/./dailyRecord/VUE3-runtime-diff.html#æ’å…¥" class="sidebar-link">æ’å…¥</a></li></ul></li><li class="sidebar-sub-header"><a href="/./dailyRecord/VUE3-runtime-diff.html#åˆ é™¤æ—§èŠ‚ç‚¹" class="sidebar-link">åˆ é™¤æ—§èŠ‚ç‚¹</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/./dailyRecord/VUE3-runtime-diff.html#ç®€ä»‹-4" class="sidebar-link">ç®€ä»‹</a></li><li class="sidebar-sub-header"><a href="/./dailyRecord/VUE3-runtime-diff.html#åˆ é™¤" class="sidebar-link">åˆ é™¤</a></li></ul></li><li class="sidebar-sub-header"><a href="/./dailyRecord/VUE3-runtime-diff.html#ä¸­é—´å¯¹æ¯”" class="sidebar-link">ä¸­é—´å¯¹æ¯”</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/./dailyRecord/VUE3-runtime-diff.html#ç®€ä»‹-5" class="sidebar-link">ç®€ä»‹</a></li><li class="sidebar-sub-header"><a href="/./dailyRecord/VUE3-runtime-diff.html#åˆ é™¤èŠ‚ç‚¹" class="sidebar-link">åˆ é™¤èŠ‚ç‚¹</a></li><li class="sidebar-sub-header"><a href="/./dailyRecord/VUE3-runtime-diff.html#æœ€é•¿é€’å¢å­åºåˆ—" class="sidebar-link">æœ€é•¿é€’å¢å­åºåˆ—</a></li><li class="sidebar-sub-header"><a href="/./dailyRecord/VUE3-runtime-diff.html#ç§»åŠ¨æˆ–åˆ›å»ºèŠ‚ç‚¹" class="sidebar-link">ç§»åŠ¨æˆ–åˆ›å»ºèŠ‚ç‚¹</a></li></ul></li><li class="sidebar-sub-header"><a href="/./dailyRecord/VUE3-runtime-diff.html#æ€»ç»“" class="sidebar-link">æ€»ç»“</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>å†…åŠŸä¿®ç‚¼</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>æ€»ç»“</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>GIS</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="äº”ã€diff-æ›´æ–°ç®—æ³•"><a href="#äº”ã€diff-æ›´æ–°ç®—æ³•" class="header-anchor">#</a> äº”ã€diff æ›´æ–°ç®—æ³•</h1> <p>GitHub: https://github.com/Roman-29/mini-vue</p> <h2 id="åŒç«¯å¯¹æ¯”"><a href="#åŒç«¯å¯¹æ¯”" class="header-anchor">#</a> åŒç«¯å¯¹æ¯”</h2> <p>æ›´æ–° element å­èŠ‚ç‚¹çš„æ—¶å€™, å½“æ–°æ—§å­èŠ‚ç‚¹éƒ½æ˜¯æ•°ç»„ç±»å‹çš„æ—¶å€™, æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨ diff ç®—æ³•ä¼˜åŒ– element æ›´æ–°é€»è¾‘. ç®—æ³•çš„æ ¸å¿ƒæ˜¯åŒç«¯å¯¹æ¯”, ä¹Ÿå°±æ˜¯å¯¹æ•°ç»„ä»å¤´åˆ°å°¾, ä»å°¾åˆ°å¤´è¿›è¡Œå¯¹æ¯”, æ‰¾åˆ°åŒç«¯ç›¸åŒçš„éƒ¨åˆ†å’Œä¸­é—´å‘ç”Ÿå˜åŒ–çš„éƒ¨åˆ†, å¯¹ä¸­é—´éƒ¨åˆ†è¿›è¡Œé’ˆå¯¹æ€§å¤„ç†(å¢åŠ /åˆ é™¤/ç§»åŠ¨ä½ç½®).</p> <h2 id="å¯¹æ¯”åŸåˆ™"><a href="#å¯¹æ¯”åŸåˆ™" class="header-anchor">#</a> å¯¹æ¯”åŸåˆ™</h2> <h3 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="header-anchor">#</a> ç®€ä»‹</h3> <p>æ‹¿åˆ°è™šæ‹ŸèŠ‚ç‚¹å¯¹æ¯” tag å’Œ key å±æ€§, åˆ¤æ–­æ˜¯å¦ä¸ºç›¸ä¼¼èŠ‚ç‚¹, å¦‚æœç›¸ä¼¼ç›´æ¥åœ¨åŸ DOM å…ƒç´ ä¸Šä¿®æ”¹, ä¸è¿›è¡Œ DOM çš„åˆ é™¤å†åˆ›å»º</p> <h3 id="ä»£ç "><a href="#ä»£ç " class="header-anchor">#</a> ä»£ç </h3> <p>åœ¨ vnode.ts å¢åŠ è™šæ‹ŸèŠ‚ç‚¹çš„ key å±æ€§</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createVnode</span><span class="token punctuation">(</span>type<span class="token punctuation">,</span> props<span class="token operator">?</span><span class="token punctuation">,</span> children<span class="token operator">?</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> vnode <span class="token operator">=</span> <span class="token punctuation">{</span>
    type<span class="token punctuation">,</span>
    props<span class="token punctuation">,</span>
    children<span class="token punctuation">,</span>
    key<span class="token operator">:</span> props <span class="token operator">&amp;&amp;</span> props<span class="token punctuation">.</span>key<span class="token punctuation">,</span> <span class="token comment">// åœ¨propså°†keyå–å‡º</span>
    shapeFlag<span class="token operator">:</span> <span class="token function">getShapeFlag</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">,</span>
    el<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>

  <span class="token operator">...</span>

  <span class="token keyword">return</span> vnode<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">isSameVNodeType</span><span class="token punctuation">(</span>n1<span class="token punctuation">,</span> n2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// åˆ¤æ–­ type å’Œ key</span>
  <span class="token keyword">return</span> n1<span class="token punctuation">.</span>type <span class="token operator">===</span> n2<span class="token punctuation">.</span>type <span class="token operator">&amp;&amp;</span> n1<span class="token punctuation">.</span>key <span class="token operator">===</span> n2<span class="token punctuation">.</span>key<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="åˆ¤æ–­å·¦ä¾§-å³ä¾§ç›¸ä¼¼èŠ‚ç‚¹"><a href="#åˆ¤æ–­å·¦ä¾§-å³ä¾§ç›¸ä¼¼èŠ‚ç‚¹" class="header-anchor">#</a> åˆ¤æ–­å·¦ä¾§/å³ä¾§ç›¸ä¼¼èŠ‚ç‚¹</h2> <h3 id="ç®€ä»‹-2"><a href="#ç®€ä»‹-2" class="header-anchor">#</a> ç®€ä»‹</h3> <p><img src="./assets/img/diff-LRCompared.drawio.f5541ced.png" alt="image"></p> <p>å¦‚å›¾, æˆ‘ä»¬éœ€è¦å¯¹æ¯”æ–°æ—§å­èŠ‚ç‚¹, æ‰¾åˆ°ä¸¤è€…å·¦ä¾§å’Œå³ä¾§ç›¸åŒéƒ¨åˆ†çš„ç´¢å¼•</p> <h3 id="ä»£ç -2"><a href="#ä»£ç -2" class="header-anchor">#</a> ä»£ç </h3> <p>åœ¨ä¸Šä¸€ç«  renderer.ts åœ¨æ›´æ–° element çš„æ—¶å€™å¯¹ä¸åŒçš„å­èŠ‚ç‚¹ç±»å‹è¿›è¡Œäº†ä¸åŒçš„å¤„ç†, è¿™é‡Œæˆ‘ä»¬å°†æ–°æ—§å­èŠ‚ç‚¹éƒ½æ˜¯æ•°ç»„çš„æƒ…å†µè¿›è¡Œè¡¥å……</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">function</span> <span class="token function">patchChildren</span><span class="token punctuation">(</span>n1<span class="token punctuation">,</span> n2<span class="token punctuation">,</span> container<span class="token punctuation">,</span> parentComponent<span class="token punctuation">,</span> anchor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> prevShapeFlag <span class="token operator">=</span> n1<span class="token punctuation">.</span>shapeFlag<span class="token punctuation">;</span>
  <span class="token keyword">const</span> shapeFlag <span class="token operator">=</span> n2<span class="token punctuation">.</span>shapeFlag<span class="token punctuation">;</span>
  <span class="token keyword">const</span> c1 <span class="token operator">=</span> n1<span class="token punctuation">.</span>children<span class="token punctuation">;</span>
  <span class="token keyword">const</span> c2 <span class="token operator">=</span> n2<span class="token punctuation">.</span>children<span class="token punctuation">;</span>

  <span class="token operator">...</span>

  <span class="token comment">// å½“prevShapeFlagå’ŒshapeFlagéƒ½æ˜¯æ•°ç»„æ—¶ é‡‡ç”¨ diff ç®—æ³•</span>
  <span class="token function">patchKeyedChildren</span><span class="token punctuation">(</span>c1<span class="token punctuation">,</span> c2<span class="token punctuation">,</span> container<span class="token punctuation">,</span> parentComponent<span class="token punctuation">,</span> anchor<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">patchKeyedChildren</span><span class="token punctuation">(</span>c1<span class="token punctuation">,</span> c2<span class="token punctuation">,</span> container<span class="token punctuation">,</span> parentComponent<span class="token punctuation">,</span> parentAnchor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">// å·¦ä¾§ç´¢å¼•</span>
  <span class="token keyword">let</span> e1 <span class="token operator">=</span> c1<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// æ—§èŠ‚ç‚¹ç›¸åŒèŠ‚ç‚¹ç´¢å¼•</span>
  <span class="token keyword">let</span> e2 <span class="token operator">=</span> c2<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// æ–°èŠ‚ç‚¹ç›¸åŒèŠ‚ç‚¹ç´¢å¼•</span>

  <span class="token comment">// å·¦ä¾§å¯¹æ¯”</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;=</span> e1 <span class="token operator">&amp;&amp;</span> i <span class="token operator">&lt;=</span> e2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> n1 <span class="token operator">=</span> c1<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> n2 <span class="token operator">=</span> c2<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSameVNodeType</span><span class="token punctuation">(</span>n1<span class="token punctuation">,</span> n2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// ç»§ç»­åˆ·æ–°èŠ‚ç‚¹ä¸‹çš„å†…å®¹</span>
      <span class="token function">patch</span><span class="token punctuation">(</span>n1<span class="token punctuation">,</span> n2<span class="token punctuation">,</span> container<span class="token punctuation">,</span> parentComponent<span class="token punctuation">,</span> parentAnchor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// èŠ‚ç‚¹å®Œå…¨ä¸ä¸€è‡´, å¯¹æ¯”ç»“æŸ, å¾—åˆ° i ä¸ºå·¦ä¾§ç›¸åŒå…ƒç´ çš„åä¸€ä½ä¸‹æ ‡</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    i<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// å³ä¾§å¯¹æ¯”</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;=</span> e1 <span class="token operator">&amp;&amp;</span> i <span class="token operator">&lt;=</span> e2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> n1 <span class="token operator">=</span> c1<span class="token punctuation">[</span>e1<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> n2 <span class="token operator">=</span> c2<span class="token punctuation">[</span>e2<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSameVNodeType</span><span class="token punctuation">(</span>n1<span class="token punctuation">,</span> n2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// ç»§ç»­åˆ·æ–°èŠ‚ç‚¹ä¸‹çš„å†…å®¹</span>
      <span class="token function">patch</span><span class="token punctuation">(</span>n1<span class="token punctuation">,</span> n2<span class="token punctuation">,</span> container<span class="token punctuation">,</span> parentComponent<span class="token punctuation">,</span> parentAnchor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// èŠ‚ç‚¹å®Œå…¨ä¸ä¸€è‡´, å¯¹æ¯”ç»“æŸ, å¾—åˆ° e1,e2 ä¸ºå³ä¾§ç›¸åŒå…ƒç´ çš„å‰ä¸€ä½ä¸‹æ ‡</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    e1<span class="token operator">--</span><span class="token punctuation">;</span>
    e2<span class="token operator">--</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="åˆ›å»ºæ–°èŠ‚ç‚¹"><a href="#åˆ›å»ºæ–°èŠ‚ç‚¹" class="header-anchor">#</a> åˆ›å»ºæ–°èŠ‚ç‚¹</h2> <h3 id="ç®€ä»‹-3"><a href="#ç®€ä»‹-3" class="header-anchor">#</a> ç®€ä»‹</h3> <p><img src="./assets/img/diff-create.drawio.a19fb9d9.png" alt="image"></p> <p>å¦‚å›¾å½“å·¦ä¾§ç´¢å¼•(i) å¤§äº æ—§èŠ‚ç‚¹ç›¸åŒèŠ‚ç‚¹ç´¢å¼•(e1)çš„æƒ…å†µå‡ºç°æ—¶, å¯ä»¥è®¤å®šåªéœ€è¦åˆ›å»ºæ–°èŠ‚ç‚¹</p> <h3 id="åˆ›å»º"><a href="#åˆ›å»º" class="header-anchor">#</a> åˆ›å»º</h3> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">function</span> <span class="token function">patchKeyedChildren</span><span class="token punctuation">(</span>c1<span class="token punctuation">,</span> c2<span class="token punctuation">,</span> container<span class="token punctuation">,</span> parentComponent<span class="token punctuation">,</span> parentAnchor<span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token operator">...</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;</span> e1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;=</span> e2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// æ–°çš„æ¯”æ—§çš„å¤š åˆ›å»ºåç»­èŠ‚ç‚¹</span>
      <span class="token keyword">const</span> nextPos <span class="token operator">=</span> e2 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token comment">// è·å–æ’å…¥çš„é”šç‚¹</span>
      <span class="token keyword">const</span> anchor <span class="token operator">=</span> nextPos <span class="token operator">&lt;</span> c2<span class="token punctuation">.</span>length <span class="token operator">?</span> c2<span class="token punctuation">[</span>nextPos<span class="token punctuation">]</span><span class="token punctuation">.</span>el <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

      <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;=</span> e2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">patch</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> c2<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> container<span class="token punctuation">,</span> parentComponent<span class="token punctuation">,</span> anchor<span class="token punctuation">)</span><span class="token punctuation">;</span>
        i<span class="token operator">++</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="æ’å…¥"><a href="#æ’å…¥" class="header-anchor">#</a> æ’å…¥</h3> <p>ç”±äºå¯èƒ½ä¼šå‡ºç°åœ¨å¤´éƒ¨æ’å…¥èŠ‚ç‚¹çš„æƒ…å†µ, æ‰€ä»¥è¦ä¿®æ”¹é»˜è®¤æ¸²æŸ“å™¨çš„ insert å‡½æ•°, å¢åŠ ä¸€ä¸ªé”šç‚¹ä½œä¸ºæ’å…¥ä¾æ®</p> <p>ä¿®æ”¹ renderer.ts</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">function</span> <span class="token function">mountElement</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> container<span class="token punctuation">,</span> parentComponent<span class="token punctuation">,</span> anchor<span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token operator">...</span>

  <span class="token comment">// å¢åŠ ä¸€ä¸ªé”šç‚¹å‚æ•°</span>
  <span class="token function">hostInsert</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> container<span class="token punctuation">,</span> anchor<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ä¿®æ”¹ runtime-dom/index.js</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">function</span> <span class="token function">insert</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> container<span class="token punctuation">,</span> anchor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// å½“é”šç‚¹ä¸ºnullæ—¶æ•ˆæœå’Œappendä¸€æ ·, ä¼šæ’å…¥åˆ°DOMå…ƒç´ çš„æœ€åé¢</span>
  container<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> anchor <span class="token operator">||</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="åˆ é™¤æ—§èŠ‚ç‚¹"><a href="#åˆ é™¤æ—§èŠ‚ç‚¹" class="header-anchor">#</a> åˆ é™¤æ—§èŠ‚ç‚¹</h2> <h3 id="ç®€ä»‹-4"><a href="#ç®€ä»‹-4" class="header-anchor">#</a> ç®€ä»‹</h3> <p><img src="./assets/img/diff-remove.drawio.877a5929.png" alt="image"></p> <p>å¦‚å›¾å½“å·¦ä¾§ç´¢å¼•(i) å¤§äº æ–°èŠ‚ç‚¹ç›¸åŒèŠ‚ç‚¹ç´¢å¼•(e2)çš„æƒ…å†µå‡ºç°æ—¶, å¯ä»¥è®¤å®šåªéœ€è¦åˆ é™¤æ—§èŠ‚ç‚¹</p> <h3 id="åˆ é™¤"><a href="#åˆ é™¤" class="header-anchor">#</a> åˆ é™¤</h3> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">function</span> <span class="token function">patchKeyedChildren</span><span class="token punctuation">(</span>c1<span class="token punctuation">,</span> c2<span class="token punctuation">,</span> container<span class="token punctuation">,</span> parentComponent<span class="token punctuation">,</span> parentAnchor<span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token operator">...</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">&gt;</span> e2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>i <span class="token operator">&lt;=</span> e1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// æ–°çš„æ¯”æ—§çš„å°‘ åˆ é™¤å¤šä½™èŠ‚ç‚¹</span>
      <span class="token function">hostRemove</span><span class="token punctuation">(</span>c1<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span>
      i<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="ä¸­é—´å¯¹æ¯”"><a href="#ä¸­é—´å¯¹æ¯”" class="header-anchor">#</a> ä¸­é—´å¯¹æ¯”</h2> <h3 id="ç®€ä»‹-5"><a href="#ç®€ä»‹-5" class="header-anchor">#</a> ç®€ä»‹</h3> <p>ä¸Šé¢æ˜¯ä¸¤ç§ç®€å•åœºæ™¯çš„å¤„ç†æ–¹å¼, ä½†æ˜¯å®é™…ä¸Šæˆ‘ä»¬ä¼šé‡åˆ°æ›´åŠ å¤æ‚çš„æƒ…å†µ, è¿™ä¸ªæ—¶å€™å°±éœ€è¦ç”¨åˆ°ä¸­é—´å¯¹æ¯”å»è§£å†³äº†</p> <h3 id="åˆ é™¤èŠ‚ç‚¹"><a href="#åˆ é™¤èŠ‚ç‚¹" class="header-anchor">#</a> åˆ é™¤èŠ‚ç‚¹</h3> <p>å¦‚å›¾, å½“æ—§èŠ‚ç‚¹ä¸­æœ‰å¤šä½™æˆ–ä¸å¯åŒ¹é…çš„å­èŠ‚ç‚¹, éƒ½è¦å¯¹å…¶è¿›è¡Œåˆ é™¤å¤„ç†</p> <p><img src="./assets/img/diff-Cremove.drawio.6856b346.png" alt="image"></p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">function</span> <span class="token function">patchKeyedChildren</span><span class="token punctuation">(</span>c1<span class="token punctuation">,</span> c2<span class="token punctuation">,</span> container<span class="token punctuation">,</span> parentComponent<span class="token punctuation">,</span> parentAnchor<span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token operator">...</span>

  <span class="token comment">// å½“ä¸Šè¿°ä¸¤ç§æƒ…å†µéƒ½ä¸æ»¡è¶³æ—¶, é‡‡ç”¨ä¸­é—´å¯¹æ¯”</span>
  <span class="token keyword">let</span> s1 <span class="token operator">=</span> i<span class="token punctuation">;</span>
  <span class="token keyword">let</span> s2 <span class="token operator">=</span> i<span class="token punctuation">;</span>

  <span class="token comment">// è®°å½•æ–°èŠ‚ç‚¹éœ€è¦å¤„ç†çš„ä¸­é—´èŠ‚ç‚¹æ€»æ•°é‡</span>
  <span class="token keyword">const</span> toBePatched <span class="token operator">=</span> e2 <span class="token operator">-</span> s2 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token comment">// è®°å½•å½“å‰å¤„ç†çš„æ•°é‡</span>
  <span class="token keyword">let</span> patched <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token comment">// æŠŠæ–°èŠ‚ç‚¹ä¸‹æ ‡å’Œkeyåšæ˜ å°„è¡¨</span>
  <span class="token keyword">const</span> keyToNewIndexMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> s2<span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> e2<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> nextChild <span class="token operator">=</span> c2<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    nextChild<span class="token punctuation">.</span>key <span class="token operator">&amp;&amp;</span> keyToNewIndexMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>nextChild<span class="token punctuation">.</span>key<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// éå†æ—§èŠ‚ç‚¹</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> s1<span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> e1<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> prevChild <span class="token operator">=</span> c1<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">// å¦‚æœå½“å‰å¤„ç†çš„æ•°é‡å·²ç»å¤§äºæ–°èŠ‚ç‚¹ä¸­é—´èŠ‚ç‚¹æ€»æ•°ï¼Œé‚£ä¹ˆæ—§èŠ‚ç‚¹ç›´æ¥åˆ é™¤å°±å¯ä»¥äº†</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>patched <span class="token operator">&gt;=</span> toBePatched<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">hostRemove</span><span class="token punctuation">(</span>prevChild<span class="token punctuation">.</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">continue</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">let</span> newIndex<span class="token punctuation">;</span>

    <span class="token comment">// æ‹¿åˆ°æ—§èŠ‚ç‚¹åœ¨æ–°èŠ‚ç‚¹å¯¹åº”çš„ä½ç½®</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>prevChild<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      newIndex <span class="token operator">=</span> keyToNewIndexMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>prevChild<span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// å¦‚æœç”¨æˆ·æ²¡æœ‰è®¾ç½®keyï¼Œé‚£ä¹ˆå°±éå†æ‰€æœ‰ï¼Œæ—¶é—´å¤æ‚åº¦ä¸ºO(n)</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> j <span class="token operator">=</span> s2<span class="token punctuation">;</span> j <span class="token operator">&lt;=</span> e2<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSameVnodeType</span><span class="token punctuation">(</span>prevChild<span class="token punctuation">,</span> c2<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          newIndex <span class="token operator">=</span> j<span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>newIndex <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// æ–°èŠ‚ç‚¹æ²¡æœ‰å¯¹åº”çš„key, ç›´æ¥åˆ é™¤</span>
      <span class="token function">hostRemove</span><span class="token punctuation">(</span>prevChild<span class="token punctuation">.</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// æ›´æ–°å¯¹åº”çš„æ—§èŠ‚ç‚¹</span>
      <span class="token function">patch</span><span class="token punctuation">(</span>prevChild<span class="token punctuation">,</span> c2<span class="token punctuation">[</span>newIndex<span class="token punctuation">]</span><span class="token punctuation">,</span> container<span class="token punctuation">,</span> parentComponent<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      patched<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="æœ€é•¿é€’å¢å­åºåˆ—"><a href="#æœ€é•¿é€’å¢å­åºåˆ—" class="header-anchor">#</a> æœ€é•¿é€’å¢å­åºåˆ—</h3> <p>åœ¨ä¸€ä¸ªç»™å®šçš„æ•°å€¼åºåˆ—ä¸­ï¼Œæ‰¾åˆ°ä¸€ä¸ªå­åºåˆ—ï¼Œä½¿å¾—è¿™ä¸ªå­åºåˆ—å…ƒç´ çš„æ•°å€¼ä¾æ¬¡é€’å¢ï¼Œå¹¶ä¸”è¿™ä¸ªå­åºåˆ—çš„é•¿åº¦å°½å¯èƒ½åœ°å¤§ã€‚</p> <p>å½“æˆ‘ä»¬å¤„ç†ä¸­é—´å­èŠ‚ç‚¹çš„ç§»åŠ¨å’Œæ·»åŠ æ—¶, å°±éœ€è¦ç”¨åˆ°æœ€é•¿é€’å¢å­åºåˆ—, é”å®šä¸­é—´èŠ‚ç‚¹&quot;æœ€ç¨³å®šéƒ¨åˆ†&quot;, ä¿®æ”¹å…¶ä»–éç¨³å®šèŠ‚ç‚¹</p> <p>å¦‚å›¾, æˆ‘ä»¬åªéœ€è¦å¤„ç†æœ€é•¿å­åºåˆ—ä»¥å¤–çš„èŠ‚ç‚¹, å°±å¯ä»¥è¾¾åˆ°æ€§èƒ½æœ€ä¼˜</p> <p><img src="./assets/img/diff.drawio.dda6fe63.png" alt="image"></p> <p>ä»£ç å¦‚ä¸‹:</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">function</span> <span class="token function">getSequence</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> p <span class="token operator">=</span> arr<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> i<span class="token punctuation">,</span> j<span class="token punctuation">,</span> u<span class="token punctuation">,</span> v<span class="token punctuation">,</span> c<span class="token punctuation">;</span>
  <span class="token keyword">const</span> len <span class="token operator">=</span> arr<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> arrI <span class="token operator">=</span> arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>arrI <span class="token operator">!==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      j <span class="token operator">=</span> result<span class="token punctuation">[</span>result<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>arr<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">&lt;</span> arrI<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        p<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> j<span class="token punctuation">;</span>
        result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">continue</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      u <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      v <span class="token operator">=</span> result<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>
      <span class="token keyword">while</span> <span class="token punctuation">(</span>u <span class="token operator">&lt;</span> v<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        c <span class="token operator">=</span> <span class="token punctuation">(</span>u <span class="token operator">+</span> v<span class="token punctuation">)</span> <span class="token operator">&gt;&gt;</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>arr<span class="token punctuation">[</span>result<span class="token punctuation">[</span>c<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> arrI<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          u <span class="token operator">=</span> c <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          v <span class="token operator">=</span> c<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>arrI <span class="token operator">&lt;</span> arr<span class="token punctuation">[</span>result<span class="token punctuation">[</span>u<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>u <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          p<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> result<span class="token punctuation">[</span>u <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        result<span class="token punctuation">[</span>u<span class="token punctuation">]</span> <span class="token operator">=</span> i<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  u <span class="token operator">=</span> result<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
  v <span class="token operator">=</span> result<span class="token punctuation">[</span>u <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>u<span class="token operator">--</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    result<span class="token punctuation">[</span>u<span class="token punctuation">]</span> <span class="token operator">=</span> v<span class="token punctuation">;</span>
    v <span class="token operator">=</span> p<span class="token punctuation">[</span>v<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="ç§»åŠ¨æˆ–åˆ›å»ºèŠ‚ç‚¹"><a href="#ç§»åŠ¨æˆ–åˆ›å»ºèŠ‚ç‚¹" class="header-anchor">#</a> ç§»åŠ¨æˆ–åˆ›å»ºèŠ‚ç‚¹</h3> <p>åœ¨ä¸Šè¿°æœ€é•¿å­åºåˆ—çš„åŸåˆ™, æˆ‘ä»¬å®ç°å¯¹èŠ‚ç‚¹è¿›è¡Œç§»åŠ¨æˆ–åˆ›å»º</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">function</span> <span class="token function">patchKeyedChildren</span><span class="token punctuation">(</span>c1<span class="token punctuation">,</span> c2<span class="token punctuation">,</span> container<span class="token punctuation">,</span> parentComponent<span class="token punctuation">,</span> parentAnchor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// å½“ä¸Šè¿°ä¸¤ç§æƒ…å†µéƒ½ä¸æ»¡è¶³æ—¶, é‡‡ç”¨ä¸­é—´å¯¹æ¯”</span>
  <span class="token keyword">let</span> s1 <span class="token operator">=</span> i<span class="token punctuation">;</span>
  <span class="token keyword">let</span> s2 <span class="token operator">=</span> i<span class="token punctuation">;</span>

  <span class="token comment">// è®°å½•æ–°èŠ‚ç‚¹éœ€è¦å¤„ç†çš„ä¸­é—´èŠ‚ç‚¹æ€»æ•°é‡</span>
  <span class="token keyword">const</span> toBePatched <span class="token operator">=</span> e2 <span class="token operator">-</span> s2 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token comment">// è®°å½•å½“å‰å¤„ç†çš„æ•°é‡</span>
  <span class="token keyword">let</span> patched <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token comment">// æŠŠæ–°èŠ‚ç‚¹ä¸‹æ ‡å’Œkeyåšæ˜ å°„è¡¨</span>
  <span class="token keyword">const</span> keyToNewIndexMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// æ–°æ—§èŠ‚ç‚¹ç´¢å¼•æ˜ å°„è¡¨</span>
  <span class="token keyword">const</span> newIndexToOldIndexMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token builtin">Array</span></span><span class="token punctuation">(</span>toBePatched<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> moved <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> maxNewIndexSoFar <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token comment">// åˆå§‹åŒ–æ˜ å°„è¡¨</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> toBePatched<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> newIndexToOldIndexMap<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> s2<span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> e2<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> nextChild <span class="token operator">=</span> c2<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    nextChild<span class="token punctuation">.</span>key <span class="token operator">&amp;&amp;</span> keyToNewIndexMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>nextChild<span class="token punctuation">.</span>key<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// éå†æ—§èŠ‚ç‚¹</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> s1<span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> e1<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> prevChild <span class="token operator">=</span> c1<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">// å¦‚æœå½“å‰å¤„ç†çš„æ•°é‡å·²ç»å¤§äºæ–°èŠ‚ç‚¹ä¸­é—´èŠ‚ç‚¹æ€»æ•°ï¼Œé‚£ä¹ˆæ—§èŠ‚ç‚¹ç›´æ¥åˆ é™¤å°±å¯ä»¥äº†</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>patched <span class="token operator">&gt;=</span> toBePatched<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">hostRemove</span><span class="token punctuation">(</span>prevChild<span class="token punctuation">.</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">continue</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">let</span> newIndex<span class="token punctuation">;</span>

    <span class="token comment">// æ‹¿åˆ°æ—§èŠ‚ç‚¹åœ¨æ–°èŠ‚ç‚¹å¯¹åº”çš„ä½ç½®</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>prevChild<span class="token punctuation">.</span>key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      newIndex <span class="token operator">=</span> keyToNewIndexMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>prevChild<span class="token punctuation">.</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// å¦‚æœç”¨æˆ·æ²¡æœ‰è®¾ç½®keyï¼Œé‚£ä¹ˆå°±éå†æ‰€æœ‰ï¼Œæ—¶é—´å¤æ‚åº¦ä¸ºO(n)</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> j <span class="token operator">=</span> s2<span class="token punctuation">;</span> j <span class="token operator">&lt;=</span> e2<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSameVnodeType</span><span class="token punctuation">(</span>prevChild<span class="token punctuation">,</span> c2<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          newIndex <span class="token operator">=</span> j<span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>newIndex <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// æ²¡æœ‰åŒ¹é…åˆ°èŠ‚ç‚¹, ç›´æ¥åˆ é™¤</span>
      <span class="token function">hostRemove</span><span class="token punctuation">(</span>prevChild<span class="token punctuation">.</span>el<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>newIndex <span class="token operator">&gt;=</span> maxNewIndexSoFar<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        maxNewIndexSoFar <span class="token operator">=</span> newIndex<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// å¦‚æœæ—§çš„èŠ‚ç‚¹åœ¨æ–°çš„èŠ‚ç‚¹é‡Œï¼Œå‰ä¸€ä¸ªç´¢å¼•æ²¡æœ‰æ¯”åé¢ä¸€ä¸ªç´¢å¼•å¤§å°±éœ€è¦ç§»åŠ¨</span>
        moved <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// 0 ä»£è¡¨è€çš„èŠ‚ç‚¹åœ¨æ–°çš„èŠ‚ç‚¹é‡Œé¢æ˜¯ä¸å­˜åœ¨çš„ï¼Œæ‰€ä»¥è¦ +1</span>
      newIndexToOldIndexMap<span class="token punctuation">[</span>newIndex <span class="token operator">-</span> s2<span class="token punctuation">]</span> <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>

      <span class="token comment">// æ›´æ–°å¯¹åº”çš„æ—§èŠ‚ç‚¹</span>
      <span class="token function">patch</span><span class="token punctuation">(</span>prevChild<span class="token punctuation">,</span> c2<span class="token punctuation">[</span>newIndex<span class="token punctuation">]</span><span class="token punctuation">,</span> container<span class="token punctuation">,</span> parentComponent<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      patched<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// æ‰¾åˆ°æœ€é•¿é€’å¢å­åºåˆ—</span>
  <span class="token keyword">const</span> increasingNewIndexSequence <span class="token operator">=</span> moved
    <span class="token operator">?</span> <span class="token function">getSequence</span><span class="token punctuation">(</span>newIndexToOldIndexMap<span class="token punctuation">)</span>
    <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> j <span class="token operator">=</span> increasingNewIndexSequence<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>

  <span class="token comment">// å› ä¸ºè°ƒç”¨çš„DOM API çš„insertBeforeæ˜¯éœ€è¦æ’å…¥åˆ°ä¸€ä¸ªå…ƒç´ çš„å‰é¢ï¼Œæ‰€ä»¥è¦ä½¿ç”¨å€’åºæ’åˆ—</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> toBePatched <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> nextIndex <span class="token operator">=</span> i <span class="token operator">+</span> s2<span class="token punctuation">;</span>
    <span class="token keyword">const</span> nextChild <span class="token operator">=</span> c2<span class="token punctuation">[</span>nextIndex<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> anchor <span class="token operator">=</span> nextIndex <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&lt;</span> c2<span class="token punctuation">.</span>length <span class="token operator">?</span> c2<span class="token punctuation">[</span>nextIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>el <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>newIndexToOldIndexMap<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// å½“æ–°èŠ‚ç‚¹åœ¨æ—§èŠ‚ç‚¹ç´¢å¼•æ˜ å°„è¡¨ä¸º0 è¡¨ç¤ºä¸å­˜åœ¨ æ–°å»ºèŠ‚ç‚¹</span>
      <span class="token function">patch</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> nextChild<span class="token punctuation">,</span> container<span class="token punctuation">,</span> parentComponent<span class="token punctuation">,</span> anchor<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>moved<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// æœ‰éœ€è¦ç§»åŠ¨çš„èŠ‚ç‚¹</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>j <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">||</span> i <span class="token operator">!==</span> increasingNewIndexSequence<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;ç§»åŠ¨ä½ç½®&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">hostInsert</span><span class="token punctuation">(</span>nextChild<span class="token punctuation">.</span>el<span class="token punctuation">,</span> container<span class="token punctuation">,</span> anchor<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        j<span class="token operator">--</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="header-anchor">#</a> æ€»ç»“</h2> <p>æ•´ä¸ªç®—æ³•çš„é€»è¾‘å›¾å¦‚ä¸‹</p> <p><img src="./assets/img/diff-summary.drawio.f023d39c.png" alt="image"></p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">9/23/2022, 9:57:03 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      â†
      <a href="/./dailyRecord/VUE3-runtime-update.html" class="prev">
        å››ã€è¿è¡Œæ—¶æ›´æ–°
      </a></span> <span class="next"><a href="/./dailyRecord/HTTP.html">
        HTTPè¯·æ±‚ä¸å“åº”
      </a>
      â†’
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="./assets/js/app.78793606.js" defer></script><script src="./assets/js/3.9a8cb714.js" defer></script><script src="./assets/js/12.f69c7e94.js" defer></script>
  </body>
</html>
