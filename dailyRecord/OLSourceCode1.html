<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>OpenLayers æºç åˆ†æ(ä¸Šç¯‡) | Notebook</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="">
    <meta name="description" content="ğŸ“æ¯å¤©è®°å½•ä¸€ç‚¹ç‚¹">
    
    <link rel="preload" href="./assets/css/0.styles.81cbcbf8.css" as="style"><link rel="preload" href="./assets/js/app.09835454.js" as="script"><link rel="preload" href="./assets/js/3.9a8cb714.js" as="script"><link rel="preload" href="./assets/js/11.a7dda998.js" as="script"><link rel="prefetch" href="./assets/js/10.beb9865c.js"><link rel="prefetch" href="./assets/js/12.b8ec8d23.js"><link rel="prefetch" href="./assets/js/13.481ecb00.js"><link rel="prefetch" href="./assets/js/14.2c7e4b48.js"><link rel="prefetch" href="./assets/js/15.47995415.js"><link rel="prefetch" href="./assets/js/16.1e2bf8c4.js"><link rel="prefetch" href="./assets/js/17.7a89769a.js"><link rel="prefetch" href="./assets/js/18.fcadf835.js"><link rel="prefetch" href="./assets/js/19.231d3618.js"><link rel="prefetch" href="./assets/js/2.33905da3.js"><link rel="prefetch" href="./assets/js/20.a85f560c.js"><link rel="prefetch" href="./assets/js/21.e075c040.js"><link rel="prefetch" href="./assets/js/22.bb17a60f.js"><link rel="prefetch" href="./assets/js/23.8188ff03.js"><link rel="prefetch" href="./assets/js/24.345a91d7.js"><link rel="prefetch" href="./assets/js/25.5b2c444b.js"><link rel="prefetch" href="./assets/js/26.2eebd931.js"><link rel="prefetch" href="./assets/js/27.f6c89798.js"><link rel="prefetch" href="./assets/js/28.58938703.js"><link rel="prefetch" href="./assets/js/29.a0b3a5cc.js"><link rel="prefetch" href="./assets/js/30.a7887201.js"><link rel="prefetch" href="./assets/js/31.cbdacff6.js"><link rel="prefetch" href="./assets/js/32.3d4caa9b.js"><link rel="prefetch" href="./assets/js/33.ba141f9f.js"><link rel="prefetch" href="./assets/js/34.7c8b3139.js"><link rel="prefetch" href="./assets/js/35.a9a3dc4c.js"><link rel="prefetch" href="./assets/js/36.1a64f97b.js"><link rel="prefetch" href="./assets/js/37.64bf3a08.js"><link rel="prefetch" href="./assets/js/38.d5a7f7a1.js"><link rel="prefetch" href="./assets/js/39.ee65b755.js"><link rel="prefetch" href="./assets/js/4.69ceb758.js"><link rel="prefetch" href="./assets/js/40.0be61706.js"><link rel="prefetch" href="./assets/js/41.af424b19.js"><link rel="prefetch" href="./assets/js/42.b47a769f.js"><link rel="prefetch" href="./assets/js/43.ed4184d6.js"><link rel="prefetch" href="./assets/js/44.8836396f.js"><link rel="prefetch" href="./assets/js/45.99c1db7a.js"><link rel="prefetch" href="./assets/js/46.2e85c6c4.js"><link rel="prefetch" href="./assets/js/47.48a5bbe5.js"><link rel="prefetch" href="./assets/js/5.2b9a4ed4.js"><link rel="prefetch" href="./assets/js/6.6f16a290.js"><link rel="prefetch" href="./assets/js/7.39aba9d0.js"><link rel="prefetch" href="./assets/js/8.abb41df8.js"><link rel="prefetch" href="./assets/js/9.92305a5c.js">
    <link rel="stylesheet" href="./assets/css/0.styles.81cbcbf8.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/./" class="home-link router-link-active"><!----> <span class="site-name">Notebook</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/./dailyRecord/" class="nav-link router-link-active">
  ğŸ“šå­¦ä¹ æ€»ç»“
</a></div><div class="nav-item"><a href="/./bookmark/" class="nav-link">
  ğŸ“Œä¹¦ç­¾æ•´ç†
</a></div><div class="nav-item"><a href="/./lint/" class="nav-link">
  âœ”ï¸ç¼–ç è§„èŒƒ&amp;ååŒå¼€å‘
</a></div><div class="nav-item"><a href="http://shooterblog.site/Learn-JS-Demo/%E5%89%8D%E7%AB%AF%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/index.html" target="_blank" rel="noopener noreferrer" class="nav-link external">
  ğŸ“–çŸ¥è¯†è„‘å›¾
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/./dailyRecord/" class="nav-link router-link-active">
  ğŸ“šå­¦ä¹ æ€»ç»“
</a></div><div class="nav-item"><a href="/./bookmark/" class="nav-link">
  ğŸ“Œä¹¦ç­¾æ•´ç†
</a></div><div class="nav-item"><a href="/./lint/" class="nav-link">
  âœ”ï¸ç¼–ç è§„èŒƒ&amp;ååŒå¼€å‘
</a></div><div class="nav-item"><a href="http://shooterblog.site/Learn-JS-Demo/%E5%89%8D%E7%AB%AF%E7%9F%A5%E8%AF%86%E5%9B%BE%E8%B0%B1/index.html" target="_blank" rel="noopener noreferrer" class="nav-link external">
  ğŸ“–çŸ¥è¯†è„‘å›¾
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>å‰ç«¯æ¨¡å—åŒ–å’Œæ‰“åŒ…å·¥å…·</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>å‰ç«¯å¼‚å¸¸ç›‘æ§</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Vue3åŸç†</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Vue3æºç </span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>å†…åŠŸä¿®ç‚¼</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>æ€»ç»“</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>GIS</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/./dailyRecord/OpenLayers.html" class="sidebar-link">OpenLayers åŸºç¡€</a></li><li><a href="/./dailyRecord/OLSourceCode1.html" aria-current="page" class="active sidebar-link">OpenLayers æºç åˆ†æ(ä¸Šç¯‡)</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/./dailyRecord/OLSourceCode1.html#ç®€ä»‹" class="sidebar-link">ç®€ä»‹</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/./dailyRecord/OLSourceCode1.html#é˜…è¯»å¯¹è±¡äººç¾¤" class="sidebar-link">é˜…è¯»å¯¹è±¡äººç¾¤</a></li></ul></li><li class="sidebar-sub-header"><a href="/./dailyRecord/OLSourceCode1.html#ç‰ˆæœ¬åŠæºç åœ°å€" class="sidebar-link">ç‰ˆæœ¬åŠæºç åœ°å€</a></li><li class="sidebar-sub-header"><a href="/./dailyRecord/OLSourceCode1.html#åˆ†æç›®å½•ç»“æ„" class="sidebar-link">åˆ†æç›®å½•ç»“æ„</a></li><li class="sidebar-sub-header"><a href="/./dailyRecord/OLSourceCode1.html#å›¾å±‚æ¸²æŸ“æµç¨‹å›¾" class="sidebar-link">å›¾å±‚æ¸²æŸ“æµç¨‹å›¾</a></li><li class="sidebar-sub-header"><a href="/./dailyRecord/OLSourceCode1.html#åœ°å›¾-map" class="sidebar-link">åœ°å›¾ (Map)</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/./dailyRecord/OLSourceCode1.html#ol-map" class="sidebar-link">ol/map</a></li><li class="sidebar-sub-header"><a href="/./dailyRecord/OLSourceCode1.html#ol-pluggablemap" class="sidebar-link">ol/PluggableMap</a></li><li class="sidebar-sub-header"><a href="/./dailyRecord/OLSourceCode1.html#ol-renderer-composite" class="sidebar-link">ol/renderer/Composite</a></li></ul></li><li class="sidebar-sub-header"><a href="/./dailyRecord/OLSourceCode1.html#layer" class="sidebar-link">Layer</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/./dailyRecord/OLSourceCode1.html#ol-layer-group" class="sidebar-link">ol/layer/Group</a></li><li class="sidebar-sub-header"><a href="/./dailyRecord/OLSourceCode1.html#ol-layer-layer" class="sidebar-link">ol/layer/Layer</a></li></ul></li><li class="sidebar-sub-header"><a href="/./dailyRecord/OLSourceCode1.html#renderer" class="sidebar-link">Renderer</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/./dailyRecord/OLSourceCode1.html#ol-renderer-canvas-imagelayer" class="sidebar-link">ol/renderer/canvas/ImageLayer</a></li><li class="sidebar-sub-header"><a href="/./dailyRecord/OLSourceCode1.html#ol-renderer-canvas-tilelayer" class="sidebar-link">ol/renderer/canvas/TileLayer</a></li><li class="sidebar-sub-header"><a href="/./dailyRecord/OLSourceCode1.html#ol-renderer-canvas-vectorlayer" class="sidebar-link">ol/renderer/canvas/VectorLayer</a></li></ul></li><li class="sidebar-sub-header"><a href="/./dailyRecord/OLSourceCode1.html#æ€»ç»“" class="sidebar-link">æ€»ç»“</a></li></ul></li><li><a href="/./dailyRecord/OLSourceCode2.html" class="sidebar-link">OpenLayers æºç åˆ†æ(ä¸‹ç¯‡)</a></li><li><a href="/./dailyRecord/ArcgisAPI.html" class="sidebar-link">Arcgis API</a></li><li><a href="/./dailyRecord/GISsystem.html" class="sidebar-link">GIS ä½“ç³»ä»‹ç»</a></li><li><a href="/./dailyRecord/SuperMapWebGL.html" class="sidebar-link">SuperMap iClient 3D for WebGL</a></li><li><a href="/./dailyRecord/SuperMapIserver.html" class="sidebar-link">SuperMap Iserver</a></li><li><a href="/./dailyRecord/SuperMap3DStudy.html" class="sidebar-link">ä¸‰ç»´WebGISå­¦ä¹ ç¬”è®°</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="openlayers-æºç åˆ†æ-ä¸Šç¯‡"><a href="#openlayers-æºç åˆ†æ-ä¸Šç¯‡" class="header-anchor">#</a> OpenLayers æºç åˆ†æ(ä¸Šç¯‡)</h1> <h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="header-anchor">#</a> ç®€ä»‹</h2> <p>ä¸Šç¯‡ä¸»è¦è®²è§£åœ°å›¾çš„æ¸²æŸ“, åŒ…æ‹¬image tile vectorä¸‰ç§å›¾å±‚çš„æ¸²æŸ“æ–¹å¼</p> <p>ä¸‹ç¯‡ä¸»è¦è®²è§£å›¾å±‚sourceçš„ç›¸å…³å†…å®¹, å³å›¾å±‚çš„æ•°æ®åŠ è½½éƒ¨åˆ†, ä»¥åŠè§†å›¾å‘ç”Ÿå˜åŒ–åçš„å¤„ç†æœºåˆ¶</p> <h3 id="é˜…è¯»å¯¹è±¡äººç¾¤"><a href="#é˜…è¯»å¯¹è±¡äººç¾¤" class="header-anchor">#</a> é˜…è¯»å¯¹è±¡äººç¾¤</h3> <p>å¯¹openlayersæœ‰ä¸€å®šçš„äº†è§£, æœ€å¥½æ˜¯ä½¿ç”¨è¿‡openlayers. å¹¶ä¸”æƒ³äº†è§£openlayersåœ°å›¾å¼•æ“çš„å·¥ä½œåŸç†.</p> <p>å¦‚æœæ²¡æœ‰ä½¿ç”¨è¿‡openlayers, å¯ä»¥çœ‹çœ‹ä¸‹é¢å‡ ä¸ªå®˜æ–¹æ¡ˆä¾‹, ç®€å•äº†è§£ä¸€ä¸‹openlayers</p> <p><a href="https://openlayers.org/en/latest/examples/arcgis-image.html" target="_blank" rel="noopener noreferrer">ä½¿ç”¨ImageLayeråŠ è½½arcgisæœåŠ¡<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://openlayers.org/en/latest/examples/arcgis-tiled.html" target="_blank" rel="noopener noreferrer">ä½¿ç”¨TileLayeråŠ è½½arcgisæœåŠ¡<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://openlayers.org/en/latest/examples/geojson.html" target="_blank" rel="noopener noreferrer">åŠ è½½geojsonæ•°æ®<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://openlayers.org/en/latest/examples/hitdetect-vector.html" target="_blank" rel="noopener noreferrer">åŠ è½½æœåŠ¡å™¨ä¸Šçš„geojsonæ•°æ®<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="ç‰ˆæœ¬åŠæºç åœ°å€"><a href="#ç‰ˆæœ¬åŠæºç åœ°å€" class="header-anchor">#</a> ç‰ˆæœ¬åŠæºç åœ°å€</h2> <p>æœ¬æ¬¡openlayersæºç å­¦ä¹ , ç ”ç©¶çš„æ˜¯openlayers 6.5.0ç‰ˆæœ¬</p> <p>https://github.com/openlayers/openlayers/tree/v6.5.0</p> <h2 id="åˆ†æç›®å½•ç»“æ„"><a href="#åˆ†æç›®å½•ç»“æ„" class="header-anchor">#</a> åˆ†æç›®å½•ç»“æ„</h2> <p>é¦–å…ˆæ‹¿åˆ°æºç å, æœ€å¥½æ˜¯æ•´ä½“è¿‡ä¸€é, çœ‹çœ‹openlayersçš„ç›®å½•ç»“æ„, ç»“åˆAPIæ–‡æ¡£, æŸ¥çœ‹ä»€ä¹ˆåŠŸèƒ½å¯¹åº”ä»€ä¹ˆè·¯å¾„, å¯¹æºç æœ‰ä¸ªåŸºæœ¬çš„è®¤è¯†. æ•´ä½“æ¥è¯´openlayersçš„ç›®å½•ç»“æ„è¿˜æ˜¯æ¯”è¾ƒæ¸…æ™°æ˜äº†çš„</p> <h2 id="å›¾å±‚æ¸²æŸ“æµç¨‹å›¾"><a href="#å›¾å±‚æ¸²æŸ“æµç¨‹å›¾" class="header-anchor">#</a> å›¾å±‚æ¸²æŸ“æµç¨‹å›¾</h2> <p>æœ¬ç¯‡å°†å›´ç»•è¿™å¼ æµç¨‹å›¾ å¯¹åœ°å›¾å’Œå›¾å±‚æ¸²æŸ“è¿›è¡Œåˆ†æ</p> <p><img src="./assets/img/07.3a1035c4.png" alt="image"></p> <h2 id="åœ°å›¾-map"><a href="#åœ°å›¾-map" class="header-anchor">#</a> åœ°å›¾ (Map)</h2> <p>åœ°å›¾æ˜¯æˆ‘ä»¬é˜…è¯»æºç çš„èµ·ç‚¹, ä¸€åˆ‡çš„ä¸€åˆ‡éƒ½è¦ä»è¿™è¯´èµ·</p> <p>ol/Map ä½œä¸ºæ„å»ºåœ°å›¾çš„ä¸»å…¥å£ï¼Œç»§æ‰¿è‡ª ol/PluggableMapï¼Œä¸»è¦é€»è¾‘åœ¨ ol/PluggableMap ä¸­å®ç°</p> <p><img src="./assets/img/06.47db26fc.png" alt="image"></p> <h3 id="ol-map"><a href="#ol-map" class="header-anchor">#</a> ol/map</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Map</span> <span class="token keyword">extends</span> <span class="token class-name">PluggableMap</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    options <span class="token operator">=</span> <span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>options<span class="token punctuation">.</span>controls<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// é»˜è®¤æ§ä»¶</span>
      options<span class="token punctuation">.</span>controls <span class="token operator">=</span> <span class="token function">defaultControls</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>options<span class="token punctuation">.</span>interactions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// é»˜è®¤äº¤äº’äº‹ä»¶</span>
      options<span class="token punctuation">.</span>interactions <span class="token operator">=</span> <span class="token function">defaultInteractions</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token literal-property property">onFocusOnly</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">createRenderer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CompositeMapRenderer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> Map<span class="token punctuation">;</span>
</code></pre></div><h3 id="ol-pluggablemap"><a href="#ol-pluggablemap" class="header-anchor">#</a> ol/PluggableMap</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">PluggableMap</span> <span class="token keyword">extends</span> <span class="token class-name">BaseObject</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// åˆ›å»ºå†…éƒ¨å±æ€§</span>
    <span class="token keyword">const</span> optionsInternal <span class="token operator">=</span> <span class="token function">createOptionsInternal</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// åœ°å›¾æ¸²æŸ“å‡½æ•°</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function-variable function">animationDelay_</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>animationDelayKey_ <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">renderFrame_</span><span class="token punctuation">(</span>Date<span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// æ„å»ºDOMâ€”â€”ol-viewport è£…è½½å›¾å±‚æ•°æ®ç­‰</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>viewport_ <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>viewport_<span class="token punctuation">.</span>className <span class="token operator">=</span>
      <span class="token string">'ol-viewport'</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token string">'ontouchstart'</span> <span class="token keyword">in</span> window <span class="token operator">?</span> <span class="token string">' ol-touch'</span> <span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>viewport_<span class="token punctuation">.</span>style<span class="token punctuation">.</span>position <span class="token operator">=</span> <span class="token string">'relative'</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>viewport_<span class="token punctuation">.</span>style<span class="token punctuation">.</span>overflow <span class="token operator">=</span> <span class="token string">'hidden'</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>viewport_<span class="token punctuation">.</span>style<span class="token punctuation">.</span>width <span class="token operator">=</span> <span class="token string">'100%'</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>viewport_<span class="token punctuation">.</span>style<span class="token punctuation">.</span>height <span class="token operator">=</span> <span class="token string">'100%'</span><span class="token punctuation">;</span>

    <span class="token comment">// å­å®¹å™¨ol-overlaycontainerã€ol-overlaycontainer-stopevent</span>
    <span class="token operator">...</span>

    <span class="token comment">// åˆ‡ç‰‡è¯·æ±‚é˜Ÿåˆ—, å¦‚æœæ˜¯tileLayerä¼šç”¨åˆ°</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>tileQueue_ <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TileQueue</span><span class="token punctuation">(</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getTilePriority</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleTileChange_</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// åœ°å›¾æµè§ˆäº‹ä»¶ã€LAYERGROUPã€VIEWã€SIZEã€SIZEçš„changeäº‹ä»¶</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>
      <span class="token function">getChangeEventType</span><span class="token punctuation">(</span>MapProperty<span class="token punctuation">.</span><span class="token constant">LAYERGROUP</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>handleLayerGroupChanged_
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>
      <span class="token function">getChangeEventType</span><span class="token punctuation">(</span>MapProperty<span class="token punctuation">.</span><span class="token constant">VIEW</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>handleViewChanged_
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>
      <span class="token function">getChangeEventType</span><span class="token punctuation">(</span>MapProperty<span class="token punctuation">.</span><span class="token constant">SIZE</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>handleSizeChanged_
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>
      <span class="token function">getChangeEventType</span><span class="token punctuation">(</span>MapProperty<span class="token punctuation">.</span><span class="token constant">TARGET</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>handleTargetChanged_
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// è®¾ç½®å†…éƒ¨å±æ€§ä¼šè§¦å‘ä¸Šé¢ç»‘å®šçš„ç›‘å¬, å¼•å‘åœ°å›¾render</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setProperties</span><span class="token punctuation">(</span>optionsInternal<span class="token punctuation">.</span>values<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">createOptionsInternal</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">controls</span><span class="token operator">:</span> controls<span class="token punctuation">,</span> <span class="token comment">// åœ°å›¾æ§ä»¶, å¦‚æœæœªæŒ‡å®šï¼Œåˆ™ä½¿ç”¨ ol/controlã€œdefaults</span>
    <span class="token literal-property property">interactions</span><span class="token operator">:</span> interactions<span class="token punctuation">,</span> <span class="token comment">// åœ°å›¾çš„äº¤äº’, å¦‚æœæœªæŒ‡å®šï¼Œåˆ™ä½¿ç”¨ ol/interactionã€œdefaults</span>
    <span class="token literal-property property">keyboardEventTarget</span><span class="token operator">:</span> keyboardEventTarget<span class="token punctuation">,</span> <span class="token comment">// ç›‘å¬é”®ç›˜äº‹ä»¶çš„DOMå…ƒç´ , é»˜è®¤</span>
    <span class="token literal-property property">overlays</span><span class="token operator">:</span> overlays<span class="token punctuation">,</span>
    <span class="token literal-property property">values</span><span class="token operator">:</span> values<span class="token punctuation">,</span> <span class="token comment">// åŒ…æ‹¬LAYERGROUP,TARGET,VIEW</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">handleTargetChanged_</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// target å¯èƒ½ä¼šæ˜¯ undefined, null, a string or an Element.</span>
    <span class="token comment">// å¦‚æœæ˜¯ string ä¼šæ‰¾åˆ°å¯¹åº”IDçš„DOM.</span>
    <span class="token comment">// å¦‚æœæ‰¾ä¸åˆ°å¯¹åº”çš„DOMå…ƒç´  å°±ç§»é™¤ viewport.</span>
    <span class="token comment">// å¦‚æœæ‰¾åˆ°å¯¹åº”DOMå…ƒç´  ä¼šå°†viewport element æ·»åŠ è¿›DOM.</span>

    <span class="token keyword">let</span> targetElement<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      targetElement <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getTargetElement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>mapBrowserEventHandler_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// å¦‚æœä¸ºtrue, è¯´æ˜ä¹‹å‰æœ‰ä¸€ä¸ªtargetæ˜¯ç”¨è¿‡çš„, éœ€è¦ç§»é™¤DOMå…ƒç´ çš„ç›‘å¬äº‹ä»¶</span>
      <span class="token operator">...</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>mapBrowserEventHandler_ <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token function">removeNode</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>viewport_<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>targetElement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// æ²¡æœ‰æ‰¾åˆ°DOMå…ƒç´ , æ¸…é™¤randerer</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      targetElement<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>viewport_<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>renderer_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// åˆ›å»º renderer/Compositeç±»</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>renderer_ <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createRenderer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token comment">// ç›‘å¬å„ç§äº‹ä»¶</span>
      <span class="token operator">...</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>handleResize_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>handleResize_ <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateSize</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>EventType<span class="token punctuation">.</span><span class="token constant">RESIZE</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handleResize_<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// è°ƒç”¨setSize, è§¦å‘this.render</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">handleSizeChanged_</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getView</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getView</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAnimating</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getView</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">resolveConstraints</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">handleViewChanged_</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// å¦‚æœæ›¾ç»æœ‰ç»‘å®šè¿‡View, å…ˆæ¸…é™¤ç›‘å¬</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>viewPropertyListenerKey_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">unlistenByKey</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>viewPropertyListenerKey_<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>viewPropertyListenerKey_ <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>viewChangeListenerKey_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">unlistenByKey</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>viewChangeListenerKey_<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>viewChangeListenerKey_ <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> view <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getView</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>view<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// é‡æ–°è®¡ç®—viewport_å…ƒç´ çš„sizeå¤§å°å¹¶å°†ä¿å­˜åœ¨viewå¯¹è±¡ä¸Š</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateViewportSize_</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">this</span><span class="token punctuation">.</span>viewPropertyListenerKey_ <span class="token operator">=</span> <span class="token function">listen</span><span class="token punctuation">(</span>
        view<span class="token punctuation">,</span>
        ObjectEventType<span class="token punctuation">.</span><span class="token constant">PROPERTYCHANGE</span><span class="token punctuation">,</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>handleViewPropertyChanged_<span class="token punctuation">,</span>
        <span class="token keyword">this</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>viewChangeListenerKey_ <span class="token operator">=</span> <span class="token function">listen</span><span class="token punctuation">(</span>
        view<span class="token punctuation">,</span>
        EventType<span class="token punctuation">.</span><span class="token constant">CHANGE</span><span class="token punctuation">,</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>handleViewPropertyChanged_<span class="token punctuation">,</span>
        <span class="token keyword">this</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>

      view<span class="token punctuation">.</span><span class="token function">resolveConstraints</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">/*
    window.requestAnimationFrame() å‘Šè¯‰æµè§ˆå™¨â€”â€”ä½ å¸Œæœ›æ‰§è¡Œä¸€ä¸ªåŠ¨ç”»ï¼Œ
    å¹¶ä¸”è¦æ±‚æµè§ˆå™¨åœ¨ä¸‹æ¬¡é‡ç»˜ä¹‹å‰è°ƒç”¨æŒ‡å®šçš„å›è°ƒå‡½æ•°æ›´æ–°åŠ¨ç”»ã€‚
    è¯¥æ–¹æ³•éœ€è¦ä¼ å…¥ä¸€ä¸ªå›è°ƒå‡½æ•°ä½œä¸ºå‚æ•°ï¼Œ
    è¯¥å›è°ƒå‡½æ•°ä¼šåœ¨æµè§ˆå™¨ä¸‹ä¸€æ¬¡é‡ç»˜ä¹‹å‰æ‰§è¡Œ
  */</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>renderer_ <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>animationDelayKey_ <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>animationDelayKey_ <span class="token operator">=</span> <span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>animationDelay_<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// æ¸²æŸ“è§†å›¾</span>
  <span class="token function">renderFrame_</span><span class="token punctuation">(</span><span class="token parameter">time</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> size <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> view <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getView</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> previousFrameState <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>frameState_<span class="token punctuation">;</span>
    <span class="token comment">/** @type {?FrameState} */</span>
    <span class="token keyword">let</span> frameState <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>size <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">&amp;&amp;</span> <span class="token function">hasArea</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> view <span class="token operator">&amp;&amp;</span> view<span class="token punctuation">.</span><span class="token function">isDef</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> viewHints <span class="token operator">=</span> view<span class="token punctuation">.</span><span class="token function">getHints</span><span class="token punctuation">(</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>frameState_ <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span>frameState_<span class="token punctuation">.</span>viewHints <span class="token operator">:</span> <span class="token keyword">undefined</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> viewState <span class="token operator">=</span> view<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// å½“å‰è§†å›¾çš„çŠ¶æ€, è¿™ä¸ªéå¸¸é‡è¦, åé¢å›¾å±‚çš„æ•°æ®åŠ è½½å’Œæ¸²æŸ“å®Œå…¨æ˜¯ä¾æ®è¿™ä¸ªæ¥çš„</span>
      frameState <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">animate</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        <span class="token literal-property property">coordinateToPixelTransform</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>coordinateToPixelTransform_<span class="token punctuation">,</span>
        <span class="token literal-property property">declutterTree</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
        <span class="token literal-property property">extent</span><span class="token operator">:</span> <span class="token function">getForViewAndSize</span><span class="token punctuation">(</span>
          viewState<span class="token punctuation">.</span>center<span class="token punctuation">,</span>
          viewState<span class="token punctuation">.</span>resolution<span class="token punctuation">,</span>
          viewState<span class="token punctuation">.</span>rotation<span class="token punctuation">,</span>
          size
        <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">index</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>frameIndex_<span class="token operator">++</span><span class="token punctuation">,</span>
        <span class="token literal-property property">layerIndex</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token literal-property property">layerStatesArray</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getLayerGroup</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getLayerStatesArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token literal-property property">pixelRatio</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pixelRatio_<span class="token punctuation">,</span>
        <span class="token literal-property property">pixelToCoordinateTransform</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pixelToCoordinateTransform_<span class="token punctuation">,</span>
        <span class="token literal-property property">postRenderFunctions</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token literal-property property">size</span><span class="token operator">:</span> size<span class="token punctuation">,</span>
        <span class="token literal-property property">tileQueue</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tileQueue_<span class="token punctuation">,</span>
        <span class="token literal-property property">time</span><span class="token operator">:</span> time<span class="token punctuation">,</span>
        <span class="token literal-property property">usedTiles</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token literal-property property">viewState</span><span class="token operator">:</span> viewState<span class="token punctuation">,</span>
        <span class="token literal-property property">viewHints</span><span class="token operator">:</span> viewHints<span class="token punctuation">,</span>
        <span class="token literal-property property">wantedTiles</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>frameState_ <span class="token operator">=</span> frameState<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>renderer_<span class="token punctuation">.</span><span class="token function">renderFrame</span><span class="token punctuation">(</span>frameState<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token operator">...</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>postRenderTimeoutHandle_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>postRenderTimeoutHandle_ <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>postRenderTimeoutHandle_ <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
        <span class="token comment">// å¤„ç†åˆ‡ç‰‡å›¾å±‚</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handlePostRender</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="ol-renderer-composite"><a href="#ol-renderer-composite" class="header-anchor">#</a> ol/renderer/Composite</h3> <p>æ‹¿åˆ°äº† frameState å, å°±å¯ä»¥å¯¹åœ°å›¾åšæ¸²æŸ“äº†.</p> <p>frameState å…³é”®å±æ€§, åŠè¯´æ˜:</p> <table><thead><tr><th>å±æ€§å</th> <th>æ¥æº</th> <th>ç®€ä»‹</th></tr></thead> <tbody><tr><td>layerStatesArray</td> <td>LayerGroup.getLayerStatesArray()</td> <td>æ‹¿åˆ°æ¯ä¸ªå›¾å±‚çš„ state</td></tr> <tr><td>layerState</td> <td>layer.getLayerState()</td> <td>åŒ…å« opacity,sourceState,visible,zIndex,ä»¥åŠå›¾å±‚è‡ªèº« ç­‰å›¾å±‚åŸºæœ¬çŠ¶æ€</td></tr> <tr><td>viewState</td> <td>view.getState()</td> <td>åŒ…æ‹¬å½“å‰è§†å›¾çš„ä¸­å¿ƒç‚¹, åˆ†è¾¨ç‡ç­‰</td></tr></tbody></table> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">CompositeMapRenderer</span> <span class="token keyword">extends</span> <span class="token class-name">MapRenderer</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">map</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">super</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// æ„å»ºlayersçš„domå®¹å™¨, å¹¶æ’å…¥</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>element_ <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> style <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>element_<span class="token punctuation">.</span>style<span class="token punctuation">;</span>
    style<span class="token punctuation">.</span>position <span class="token operator">=</span> <span class="token string">'absolute'</span><span class="token punctuation">;</span>
    style<span class="token punctuation">.</span>width <span class="token operator">=</span> <span class="token string">'100%'</span><span class="token punctuation">;</span>
    style<span class="token punctuation">.</span>height <span class="token operator">=</span> <span class="token string">'100%'</span><span class="token punctuation">;</span>
    style<span class="token punctuation">.</span>zIndex <span class="token operator">=</span> <span class="token string">'0'</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>element_<span class="token punctuation">.</span>className <span class="token operator">=</span> <span class="token constant">CLASS_UNSELECTABLE</span> <span class="token operator">+</span> <span class="token string">' ol-layers'</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> container <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">getViewport</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    container<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>element_<span class="token punctuation">,</span> container<span class="token punctuation">.</span>firstChild <span class="token operator">||</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token operator">...</span>
  <span class="token punctuation">}</span>

  <span class="token function">renderFrame</span><span class="token punctuation">(</span><span class="token parameter">frameState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">dispatchRenderEvent</span><span class="token punctuation">(</span>RenderEventType<span class="token punctuation">.</span><span class="token constant">PRECOMPOSE</span><span class="token punctuation">,</span> frameState<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> layerStatesArray <span class="token operator">=</span> frameState<span class="token punctuation">.</span>layerStatesArray<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> a<span class="token punctuation">.</span>zIndex <span class="token operator">-</span> b<span class="token punctuation">.</span>zIndex<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> viewState <span class="token operator">=</span> frameState<span class="token punctuation">.</span>viewState<span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>children_<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> declutterLayers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> previousElement <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> ii <span class="token operator">=</span> layerStatesArray<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ii<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> layerState <span class="token operator">=</span> layerStatesArray<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
      frameState<span class="token punctuation">.</span>layerIndex <span class="token operator">=</span> i<span class="token punctuation">;</span>
      <span class="token comment">/** åˆ¤æ–­æ˜¯å¦éœ€è¦åŠ è½½layer åˆ¤æ–­æ¡ä»¶åŒ…æ‹¬:
       * 1. visible
       * 2. æ˜¯å¦è¶…å‡ºresolutionèŒƒå›´(max/min)
       * 3. æ˜¯å¦è¶…å‡ºzoomèŒƒå›´(max/min) 
       * 4. SourceStateæ˜¯å¦ä¸ºready
      */</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>
        <span class="token operator">!</span><span class="token function">inView</span><span class="token punctuation">(</span>layerState<span class="token punctuation">,</span> viewState<span class="token punctuation">)</span> <span class="token operator">||</span>
        <span class="token punctuation">(</span>layerState<span class="token punctuation">.</span>sourceState <span class="token operator">!=</span> SourceState<span class="token punctuation">.</span><span class="token constant">READY</span> <span class="token operator">&amp;&amp;</span>
          layerState<span class="token punctuation">.</span>sourceState <span class="token operator">!=</span> SourceState<span class="token punctuation">.</span><span class="token constant">UNDEFINED</span><span class="token punctuation">)</span>
      <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">continue</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">const</span> layer <span class="token operator">=</span> layerState<span class="token punctuation">.</span>layer<span class="token punctuation">;</span>
      <span class="token comment">// å¯¹æ¯ä¸ªå›¾å±‚è¿›è¡Œrender, å¾—åˆ°å›¾å±‚çš„DOMå…ƒç´ </span>
      <span class="token keyword">const</span> element <span class="token operator">=</span> layer<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span>frameState<span class="token punctuation">,</span> previousElement<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>element<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">continue</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>element <span class="token operator">!==</span> previousElement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>children_<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>element<span class="token punctuation">)</span><span class="token punctuation">;</span>
        previousElement <span class="token operator">=</span> element<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token function">replaceChildren</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>element_<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>children_<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">dispatchRenderEvent</span><span class="token punctuation">(</span>RenderEventType<span class="token punctuation">.</span><span class="token constant">POSTCOMPOSE</span><span class="token punctuation">,</span> frameState<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token operator">...</span>
  <span class="token punctuation">}</span>
</code></pre></div><h2 id="layer"><a href="#layer" class="header-anchor">#</a> Layer</h2> <p>åœ¨openlayersä¸­, layeräº¤ç”±layerGroupè¿›è¡Œç»Ÿä¸€ç®¡ç†, æ§åˆ¶å›¾å±‚çš„é¡ºåºç­‰</p> <p>layerå¹¶æ²¡æœ‰æ¶‰åŠå¾ˆå¤šä¸šåŠ¡å¤„ç†, å…¶æ›´åŠ åƒæ˜¯ä¸€ä¸ªç®¡ç†è€…çš„è§’è‰², æ§åˆ¶æ ¸å¿ƒå±æ€§, æ¯”å¦‚å›¾å±‚çš„æ˜¾éš, å…·ä½“å¦‚ä½•å¯¹å›¾å±‚å¦‚ä½•è¯·æ±‚æ•°æ®, æ¸²æŸ“æ•°æ®æ˜¯äº¤ç»™äº†Sourceå’ŒRendererç±»å»å®Œæˆ</p> <p><img src="./assets/img/04.46e6c2a2.png" alt="image"></p> <h3 id="ol-layer-group"><a href="#ol-layer-group" class="header-anchor">#</a> ol/layer/Group</h3> <p>layerGroup ä½œä¸ºåœ°å›¾çš„å›¾å±‚ç®¡ç†è€…è§’è‰², ç®¡ç†åœ°å›¾å¯¹è±¡ä¸‹çš„å…¨éƒ¨å›¾å±‚</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">LayerGroup</span> <span class="token keyword">extends</span> <span class="token class-name">BaseLayer</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">opt_options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> options <span class="token operator">=</span> opt_options <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> baseOptions <span class="token operator">=</span> <span class="token comment">/** @type {Options} */</span> <span class="token punctuation">(</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">delete</span> baseOptions<span class="token punctuation">.</span>layers<span class="token punctuation">;</span>

    <span class="token keyword">let</span> layers <span class="token operator">=</span> options<span class="token punctuation">.</span>layers<span class="token punctuation">;</span>

    <span class="token keyword">super</span><span class="token punctuation">(</span>baseOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>layers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>layers<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        layers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Collection</span><span class="token punctuation">(</span>layers<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">unique</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">assert</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> <span class="token punctuation">(</span><span class="token comment">/** @type {?} */</span> <span class="token punctuation">(</span>layers<span class="token punctuation">)</span><span class="token punctuation">.</span>getArray<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">&quot;function&quot;</span><span class="token punctuation">,</span> <span class="token number">43</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Expected `layers` to be an array or a `Collection`</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      layers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Collection</span><span class="token punctuation">(</span><span class="token keyword">undefined</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token literal-property property">unique</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setLayers</span><span class="token punctuation">(</span>layers<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// è·å–groupä¸‹æ‰€æœ‰å›¾å±‚state</span>
  <span class="token function">getLayerStatesArray</span><span class="token punctuation">(</span><span class="token parameter">opt_states</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> states <span class="token operator">=</span> opt_states <span class="token operator">!==</span> <span class="token keyword">undefined</span> <span class="token operator">?</span> opt_states <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> pos <span class="token operator">=</span> states<span class="token punctuation">.</span>length<span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getLayers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">layer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      layer<span class="token punctuation">.</span><span class="token function">getLayerStatesArray</span><span class="token punctuation">(</span>states<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> ownLayerState <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getLayerState</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// å¯¹æ¯”Groupçš„Stateå’ŒLayerçš„State, LayerStateä¸èƒ½è¶…è¿‡GroupState</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> pos<span class="token punctuation">,</span> ii <span class="token operator">=</span> states<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ii<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> layerState <span class="token operator">=</span> states<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
      layerState<span class="token punctuation">.</span>opacity <span class="token operator">*=</span> ownLayerState<span class="token punctuation">.</span>opacity<span class="token punctuation">;</span>
      layerState<span class="token punctuation">.</span>visible <span class="token operator">=</span> layerState<span class="token punctuation">.</span>visible <span class="token operator">&amp;&amp;</span> ownLayerState<span class="token punctuation">.</span>visible<span class="token punctuation">;</span>
      layerState<span class="token punctuation">.</span>maxResolution <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>
        layerState<span class="token punctuation">.</span>maxResolution<span class="token punctuation">,</span>
        ownLayerState<span class="token punctuation">.</span>maxResolution
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      layerState<span class="token punctuation">.</span>minResolution <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>
        layerState<span class="token punctuation">.</span>minResolution<span class="token punctuation">,</span>
        ownLayerState<span class="token punctuation">.</span>minResolution
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      layerState<span class="token punctuation">.</span>minZoom <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>layerState<span class="token punctuation">.</span>minZoom<span class="token punctuation">,</span> ownLayerState<span class="token punctuation">.</span>minZoom<span class="token punctuation">)</span><span class="token punctuation">;</span>
      layerState<span class="token punctuation">.</span>maxZoom <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>layerState<span class="token punctuation">.</span>maxZoom<span class="token punctuation">,</span> ownLayerState<span class="token punctuation">.</span>maxZoom<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>ownLayerState<span class="token punctuation">.</span>extent <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>layerState<span class="token punctuation">.</span>extent <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          layerState<span class="token punctuation">.</span>extent <span class="token operator">=</span> <span class="token function">getIntersection</span><span class="token punctuation">(</span>
            layerState<span class="token punctuation">.</span>extent<span class="token punctuation">,</span>
            ownLayerState<span class="token punctuation">.</span>extent
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          layerState<span class="token punctuation">.</span>extent <span class="token operator">=</span> ownLayerState<span class="token punctuation">.</span>extent<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> states<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="ol-layer-layer"><a href="#ol-layer-layer" class="header-anchor">#</a> ol/layer/Layer</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Layer</span> <span class="token keyword">extends</span> <span class="token class-name">BaseLayer</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> baseOptions <span class="token operator">=</span> <span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">delete</span> baseOptions<span class="token punctuation">.</span>source<span class="token punctuation">;</span>

    <span class="token keyword">super</span><span class="token punctuation">(</span>baseOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Overwrite default render method with a custom one</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>render<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>render <span class="token operator">=</span> options<span class="token punctuation">.</span>render<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// ç›‘å¬sourceå˜åŒ–</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>
      <span class="token function">getChangeEventType</span><span class="token punctuation">(</span>LayerProperty<span class="token punctuation">.</span><span class="token constant">SOURCE</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>handleSourcePropertyChange_
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> source <span class="token operator">=</span> options<span class="token punctuation">.</span>source
      <span class="token operator">?</span> <span class="token comment">/** @type {SourceType} */</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>source<span class="token punctuation">)</span>
      <span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setSource</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">handleSourcePropertyChange_</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sourceChangeKey_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">unlistenByKey</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>sourceChangeKey_<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>sourceChangeKey_ <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> source <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>source<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>sourceChangeKey_ <span class="token operator">=</span> <span class="token function">listen</span><span class="token punctuation">(</span>
        source<span class="token punctuation">,</span>
        EventType<span class="token punctuation">.</span><span class="token constant">CHANGE</span><span class="token punctuation">,</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>changed<span class="token punctuation">,</span>
        <span class="token keyword">this</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">changed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// è§¦å‘layerçš„changeäº‹ä»¶</span>
  <span class="token function">changed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">++</span><span class="token keyword">this</span><span class="token punctuation">.</span>revision_<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">dispatchEvent</span><span class="token punctuation">(</span>EventType<span class="token punctuation">.</span><span class="token constant">CHANGE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// å›¾å±‚çš„æ¸²æŸ“æ–¹æ³•</span>
  <span class="token function">render</span><span class="token punctuation">(</span><span class="token parameter">frameState<span class="token punctuation">,</span> target</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> layerRenderer <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getRenderer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>layerRenderer<span class="token punctuation">.</span><span class="token function">prepareFrame</span><span class="token punctuation">(</span>frameState<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> layerRenderer<span class="token punctuation">.</span><span class="token function">renderFrame</span><span class="token punctuation">(</span>frameState<span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">getRenderer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>renderer_<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>renderer_ <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createRenderer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>renderer_<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// layerä½œä¸ºå›¾å±‚åŸºç±», æœ¬èº«ä¸åˆ›å»ºrenderer, ç”±å…·ä½“å­ç±»å†³å®š</span>
  <span class="token function">createRenderer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="renderer"><a href="#renderer" class="header-anchor">#</a> Renderer</h2> <p>å›¾å±‚çš„æ¸²æŸ“æ˜¯äº¤ç”±Rendererå®Œæˆ, æŸ¥çœ‹ol/renderer/canvas å¯ä»¥å‘ç°, rendererä¸»è¦æ˜¯åˆ†ä¸ºä¸‰å¤§ç±»:</p> <ol><li>Image</li> <li>Tile</li> <li>Vector</li></ol> <p><img src="./assets/img/05.49133c03.png" alt="image"></p> <h3 id="ol-renderer-canvas-imagelayer"><a href="#ol-renderer-canvas-imagelayer" class="header-anchor">#</a> ol/renderer/canvas/ImageLayer</h3> <p>åœ¨ prepareFrameä¸­, éœ€è¦å¾—åˆ°imageSourceçš„ image, ä¸”image ä¸ºåŠ è½½å®ŒæˆçŠ¶æ€, æ‰ä¼šè¿”å›image, æ‰§è¡ŒrenderFrame, å¦åˆ™ä¸æ‰§è¡Œ.</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token function">prepareFrame</span><span class="token punctuation">(</span><span class="token parameter">frameState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      <span class="token operator">!</span>hints<span class="token punctuation">[</span>ViewHint<span class="token punctuation">.</span><span class="token constant">ANIMATING</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span>
      <span class="token operator">!</span>hints<span class="token punctuation">[</span>ViewHint<span class="token punctuation">.</span><span class="token constant">INTERACTING</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span>
      <span class="token operator">!</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>renderedExtent<span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>imageSource<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> projection <span class="token operator">=</span> viewState<span class="token punctuation">.</span>projection<span class="token punctuation">;</span>
        
        <span class="token keyword">const</span> image <span class="token operator">=</span> imageSource<span class="token punctuation">.</span><span class="token function">getImage</span><span class="token punctuation">(</span>
          renderedExtent<span class="token punctuation">,</span>
          viewResolution<span class="token punctuation">,</span>
          pixelRatio<span class="token punctuation">,</span>
          projection
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>image <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">loadImage</span><span class="token punctuation">(</span>image<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>image_ <span class="token operator">=</span> image<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>image_ <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token operator">!</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>image_<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>å¦‚æœprepareFrameå‡½æ•°è¿”å›äº†this.image_, åˆ™è¿›è¡Œcanvasç»˜åˆ¶, å°†å›¾å±‚ç»˜åˆ¶å‡ºæ¥</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token function">renderFrame</span><span class="token punctuation">(</span><span class="token parameter">frameState<span class="token punctuation">,</span> target</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> image <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>image_<span class="token punctuation">;</span>

    <span class="token comment">// ç”Ÿæˆcontext(å›¾å±‚çš„DOM)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">useContainer</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> canvasTransform<span class="token punctuation">,</span> layerState<span class="token punctuation">.</span>opacity<span class="token punctuation">)</span><span class="token punctuation">;</span> 

    <span class="token keyword">const</span> context <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">;</span>
    <span class="token keyword">const</span> canvas <span class="token operator">=</span> context<span class="token punctuation">.</span>canvas<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>canvas<span class="token punctuation">.</span>width <span class="token operator">!=</span> width <span class="token operator">||</span> canvas<span class="token punctuation">.</span>height <span class="token operator">!=</span> height<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      canvas<span class="token punctuation">.</span>width <span class="token operator">=</span> width<span class="token punctuation">;</span>
      canvas<span class="token punctuation">.</span>height <span class="token operator">=</span> height<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>containerReused<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      context<span class="token punctuation">.</span><span class="token function">clearRect</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">const</span> img <span class="token operator">=</span> image<span class="token punctuation">.</span><span class="token function">getImage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// è®¡ç®—canvasç»˜åˆ¶ä¸ºä¿è¯å›¾ç‰‡ä¸å˜å½¢çš„åç§»é‡(dx,dy,dw,dh)</span>
    <span class="token operator">...</span>

    <span class="token function">assign</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getLayer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getContextOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">preRender</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> frameState<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>dw <span class="token operator">&gt;=</span> <span class="token number">0.5</span> <span class="token operator">&amp;&amp;</span> dh <span class="token operator">&gt;=</span> <span class="token number">0.5</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> opacity <span class="token operator">=</span> layerState<span class="token punctuation">.</span>opacity<span class="token punctuation">;</span>
      <span class="token keyword">let</span> previousAlpha<span class="token punctuation">;</span>
      <span class="token comment">// ä¿®æ”¹é€æ˜åº¦</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>opacity <span class="token operator">!==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        previousAlpha <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span>globalAlpha<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span>globalAlpha <span class="token operator">=</span> opacity<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token comment">// ç»˜åˆ¶å›¾ç‰‡</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span><span class="token function">drawImage</span><span class="token punctuation">(</span>
        img<span class="token punctuation">,</span>
        <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token number">0</span><span class="token punctuation">,</span>
        <span class="token operator">+</span>img<span class="token punctuation">.</span>width<span class="token punctuation">,</span>
        <span class="token operator">+</span>img<span class="token punctuation">.</span>height<span class="token punctuation">,</span>
        Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span>dx<span class="token punctuation">)</span><span class="token punctuation">,</span>
        Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span>dy<span class="token punctuation">)</span><span class="token punctuation">,</span>
        Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span>dw<span class="token punctuation">)</span><span class="token punctuation">,</span>
        Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span>dh<span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>opacity <span class="token operator">!==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">.</span>globalAlpha <span class="token operator">=</span> previousAlpha<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">postRender</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> frameState<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>canvasTransform <span class="token operator">!==</span> canvas<span class="token punctuation">.</span>style<span class="token punctuation">.</span>transform<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      canvas<span class="token punctuation">.</span>style<span class="token punctuation">.</span>transform <span class="token operator">=</span> canvasTransform<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>container<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><h3 id="ol-renderer-canvas-tilelayer"><a href="#ol-renderer-canvas-tilelayer" class="header-anchor">#</a> ol/renderer/canvas/TileLayer</h3> <p>åœ¨prepareFrameä¸­æ£€æŸ¥å›¾å±‚æ˜¯å¦æœ‰source, å¦‚æœæœ‰å°±æ‰§è¡ŒrenderFrame</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token function">prepareFrame</span><span class="token punctuation">(</span><span class="token parameter">frameState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">!</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getLayer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code>  <span class="token function">renderFrame</span><span class="token punctuation">(</span><span class="token parameter">frameState<span class="token punctuation">,</span> target</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>

    <span class="token comment">// è·å–åˆ‡ç‰‡å·èŒƒå›´</span>
    <span class="token keyword">const</span> tileRange <span class="token operator">=</span> tileGrid<span class="token punctuation">.</span><span class="token function">getTileRangeForExtentAndZ</span><span class="token punctuation">(</span>extent<span class="token punctuation">,</span> z<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> tilesToDrawByZ <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    tilesToDrawByZ<span class="token punctuation">[</span>z<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

    <span class="token comment">// æŸ¥æ‰¾å·²åŠ è½½çš„tiles</span>
    <span class="token keyword">const</span> findLoadedTiles <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createLoadedTileFinder</span><span class="token punctuation">(</span>
      tileSource<span class="token punctuation">,</span>
      projection<span class="token punctuation">,</span>
      tilesToDrawByZ
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> tmpExtent <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tmpExtent<span class="token punctuation">;</span>
    <span class="token keyword">const</span> tmpTileRange <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>tmpTileRange_<span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>newTiles_ <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> x <span class="token operator">=</span> tileRange<span class="token punctuation">.</span>minX<span class="token punctuation">;</span> x <span class="token operator">&lt;=</span> tileRange<span class="token punctuation">.</span>maxX<span class="token punctuation">;</span> <span class="token operator">++</span>x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> y <span class="token operator">=</span> tileRange<span class="token punctuation">.</span>minY<span class="token punctuation">;</span> y <span class="token operator">&lt;=</span> tileRange<span class="token punctuation">.</span>maxY<span class="token punctuation">;</span> <span class="token operator">++</span>y<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// è·å–åˆ‡ç‰‡</span>
        <span class="token keyword">const</span> tile <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getTile</span><span class="token punctuation">(</span>z<span class="token punctuation">,</span> x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> frameState<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">isDrawableTile</span><span class="token punctuation">(</span>tile<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> uid <span class="token operator">=</span> <span class="token function">getUid</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>tile<span class="token punctuation">.</span><span class="token function">getState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> TileState<span class="token punctuation">.</span><span class="token constant">LOADED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// å·²ç»åŠ è½½å¥½çš„tileå­˜å…¥tilesToDrawByZ, ç­‰å¾…ç»˜åˆ¶canvas</span>
            tilesToDrawByZ<span class="token punctuation">[</span>z<span class="token punctuation">]</span><span class="token punctuation">[</span>tile<span class="token punctuation">.</span>tileCoord<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token operator">=</span> tile<span class="token punctuation">;</span>
            <span class="token operator">...</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// æŸ¥æ‰¾è¿™ä¸ªåˆ‡ç‰‡å¯¹åº”çš„ä¸‹ä¸€çº§åˆ‡ç‰‡</span>
        <span class="token keyword">const</span> childTileRange <span class="token operator">=</span> tileGrid<span class="token punctuation">.</span><span class="token function">getTileCoordChildTileRange</span><span class="token punctuation">(</span>
          tile<span class="token punctuation">.</span>tileCoord<span class="token punctuation">,</span>
          tmpTileRange<span class="token punctuation">,</span>
          tmpExtent
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">let</span> covered <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>childTileRange<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          covered <span class="token operator">=</span> <span class="token function">findLoadedTiles</span><span class="token punctuation">(</span>z <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> childTileRange<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>covered<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          tileGrid<span class="token punctuation">.</span><span class="token function">forEachTileCoordParentTileRange</span><span class="token punctuation">(</span>
            tile<span class="token punctuation">.</span>tileCoord<span class="token punctuation">,</span>
            findLoadedTiles<span class="token punctuation">,</span>
            tmpTileRange<span class="token punctuation">,</span>
            tmpExtent
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">useContainer</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> canvasTransform<span class="token punctuation">,</span> layerState<span class="token punctuation">.</span>opacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> context <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">;</span>
    <span class="token keyword">const</span> canvas <span class="token operator">=</span> context<span class="token punctuation">.</span>canvas<span class="token punctuation">;</span>


    <span class="token keyword">if</span> <span class="token punctuation">(</span>canvas<span class="token punctuation">.</span>width <span class="token operator">!=</span> width <span class="token operator">||</span> canvas<span class="token punctuation">.</span>height <span class="token operator">!=</span> height<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      canvas<span class="token punctuation">.</span>width <span class="token operator">=</span> width<span class="token punctuation">;</span>
      canvas<span class="token punctuation">.</span>height <span class="token operator">=</span> height<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>containerReused<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      context<span class="token punctuation">.</span><span class="token function">clearRect</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token function">assign</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> tileSource<span class="token punctuation">.</span><span class="token function">getContextOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">preRender</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> frameState<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>renderedTiles<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">// å¯¹Zè¿›è¡Œæ’åº, æŒ‰é¡ºåºåŠ è½½</span>
    <span class="token keyword">let</span> zs <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>tilesToDrawByZ<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>Number<span class="token punctuation">)</span><span class="token punctuation">;</span>
    zs<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>numberSafeCompareFunction<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> zs<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token operator">--</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// è®¡ç®—åˆ‡ç‰‡å·¦ä¸Šè§’çš„åç§»é‡ç­‰</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> tileCoordKey <span class="token keyword">in</span> tilesToDraw<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token operator">...</span>

        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">drawTileImage</span><span class="token punctuation">(</span>
          tile<span class="token punctuation">,</span>
          frameState<span class="token punctuation">,</span>
          x<span class="token punctuation">,</span>
          y<span class="token punctuation">,</span>
          w<span class="token punctuation">,</span>
          h<span class="token punctuation">,</span>
          tileGutter<span class="token punctuation">,</span>
          transition<span class="token punctuation">,</span>
          layerState<span class="token punctuation">.</span>opacity
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>clips <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>inTransition<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          context<span class="token punctuation">.</span><span class="token function">restore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>renderedTiles<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>tile<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">updateUsedTiles</span><span class="token punctuation">(</span>frameState<span class="token punctuation">.</span>usedTiles<span class="token punctuation">,</span> tileSource<span class="token punctuation">,</span> tile<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// å¦‚æœtileæ²¡æœ‰åœ¨tileQueueåˆ™å°†tileå…¥é˜Ÿ</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">manageTilePyramid</span><span class="token punctuation">(</span>
      frameState<span class="token punctuation">,</span>
      tileSource<span class="token punctuation">,</span>
      tileGrid<span class="token punctuation">,</span>
      pixelRatio<span class="token punctuation">,</span>
      projection<span class="token punctuation">,</span>
      extent<span class="token punctuation">,</span>
      z<span class="token punctuation">,</span>
      tileLayer<span class="token punctuation">.</span><span class="token function">getPreload</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>container<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><h3 id="ol-renderer-canvas-vectorlayer"><a href="#ol-renderer-canvas-vectorlayer" class="header-anchor">#</a> ol/renderer/canvas/VectorLayer</h3> <p>çŸ¢é‡æ•°æ®çš„æ¸²æŸ“å’Œå‰é¢çš„ä¸¤ä¸ªç±»å‹å¾ˆä¸ä¸€æ ·, å‰é¢æ˜¯è·å–åˆ°å›¾ç‰‡ç›´æ¥ç»˜åˆ¶åˆ°canvas, è€ŒçŸ¢é‡æ•°æ®è¦æ ¹æ®åæ ‡ç‚¹å’Œè¦ç´ æ ·å¼çš„ä¸åŒ, å»å¯¹canvasåšä¸åŒçš„æ“ä½œ, æ‰èƒ½å°†è¦ç´ ç»˜åˆ¶åˆ°canvasä¸Š</p> <p>åœ¨prepareFrame å‡½æ•°ä¸­, ä¸»è¦æ˜¯å°†å·²ç»åŠ è½½çš„featureé€šè¿‡ render/canvas/Build æ–‡ä»¶å¤¹ä¸‹çš„å„ç§GEOç±»å‹çš„ build å·¥å…·ç±»è¿›è¡Œè§£æ, å¾—åˆ°canvasæŒ‡ä»¤</p> <p><img src="./assets/img/10.540d5826.png" alt="image"></p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token function">prepareFrame</span><span class="token punctuation">(</span><span class="token parameter">frameState</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> vectorLayer <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getLayer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> vectorSource <span class="token operator">=</span> vectorLayer<span class="token punctuation">.</span><span class="token function">getSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>vectorSource<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token operator">...</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>replayGroup_ <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>dirty_ <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

    <span class="token comment">// å®ä¾‹åŒ–canvasæŒ‡ä»¤æ„é€ ç»„, ä¼šæ ¹æ®ä¸åŒçš„GEOç±»å‹è¿›è¡ŒcanvasæŒ‡ä»¤æ„é€ </span>
    <span class="token keyword">const</span> replayGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CanvasBuilderGroup</span><span class="token punctuation">(</span>
      <span class="token function">getRenderTolerance</span><span class="token punctuation">(</span>resolution<span class="token punctuation">,</span> pixelRatio<span class="token punctuation">)</span><span class="token punctuation">,</span>
      extent<span class="token punctuation">,</span>
      resolution<span class="token punctuation">,</span>
      pixelRatio
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token operator">...</span>

    <span class="token comment">// è·å–å¤–éƒ¨çŸ¢é‡æ•°æ®(å‘é€ç½‘ç»œè¯·æ±‚)</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> ii <span class="token operator">=</span> loadExtents<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ii<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      vectorSource<span class="token punctuation">.</span><span class="token function">loadFeatures</span><span class="token punctuation">(</span>loadExtents<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> resolution<span class="token punctuation">,</span> projection<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">const</span> squaredTolerance <span class="token operator">=</span> <span class="token function">getSquaredRenderTolerance</span><span class="token punctuation">(</span>resolution<span class="token punctuation">,</span> pixelRatio<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// æ¸²æŸ“feature</span>
    <span class="token keyword">const</span> <span class="token function-variable function">render</span> <span class="token operator">=</span>
      <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">feature</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> styles<span class="token punctuation">;</span>
        <span class="token keyword">const</span> styleFunction <span class="token operator">=</span>
          feature<span class="token punctuation">.</span><span class="token function">getStyleFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> vectorLayer<span class="token punctuation">.</span><span class="token function">getStyleFunction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>styleFunction<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          styles <span class="token operator">=</span> <span class="token function">styleFunction</span><span class="token punctuation">(</span>feature<span class="token punctuation">,</span> resolution<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// å¾—åˆ°style,å¼€å§‹ç”ŸæˆcanvasæŒ‡ä»¤</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>styles<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> dirty <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">renderFeature</span><span class="token punctuation">(</span>
            feature<span class="token punctuation">,</span>
            squaredTolerance<span class="token punctuation">,</span>
            styles<span class="token punctuation">,</span>
            replayGroup<span class="token punctuation">,</span>
            userTransform<span class="token punctuation">,</span>
            declutterBuilderGroup
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>dirty_ <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>dirty_ <span class="token operator">||</span> dirty<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> userExtent <span class="token operator">=</span> <span class="token function">toUserExtent</span><span class="token punctuation">(</span>extent<span class="token punctuation">,</span> projection<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// æ ¹æ®èŒƒå›´è¿‡æ»¤è¦ç´ </span>
    <span class="token keyword">const</span> features <span class="token operator">=</span> vectorSource<span class="token punctuation">.</span><span class="token function">getFeaturesInExtent</span><span class="token punctuation">(</span>userExtent<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>vectorLayerRenderOrder<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      features<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span>vectorLayerRenderOrder<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// éå†æ¸²æŸ“è¦ç´ </span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> ii <span class="token operator">=</span> features<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ii<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">render</span><span class="token punctuation">(</span>features<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>renderedFeatures_ <span class="token operator">=</span> features<span class="token punctuation">;</span>

    <span class="token comment">// å¾—åˆ°è¦æ¸²æŸ“çš„è¦ç´ çš„canvasæŒ‡ä»¤</span>
    <span class="token keyword">const</span> replayGroupInstructions <span class="token operator">=</span> replayGroup<span class="token punctuation">.</span><span class="token function">finish</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// æ„å»ºæ¸²æŸ“å™¨, åé¢executorGroupä¼šåœ¨renderWorldså‡½æ•°ä¸­æ ¹æ®replayGroupInstructionsé‡Œé¢çš„canvasæŒ‡ä»¤, ä½¿ç”¨ä¸åŒGEOç±»å‹çš„Executorå¯¹canvasæ‰§è¡Œç»˜åˆ¶</span>
    <span class="token keyword">const</span> executorGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ExecutorGroup</span><span class="token punctuation">(</span>
      extent<span class="token punctuation">,</span>
      resolution<span class="token punctuation">,</span>
      pixelRatio<span class="token punctuation">,</span>
      vectorSource<span class="token punctuation">.</span><span class="token function">getOverlaps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      replayGroupInstructions<span class="token punctuation">,</span>
      vectorLayer<span class="token punctuation">.</span><span class="token function">getRenderBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token operator">...</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>åœ¨ç”Ÿæˆäº†canvasæŒ‡ä»¤å, åœ¨renderFrame å°†æŒ‡ä»¤ç¿»è¯‘æˆç»˜åˆ¶canvasçš„ä»£ç è¿›è¡Œç»˜åˆ¶</p> <div class="language-js extra-class"><pre class="language-js"><code>  <span class="token function">renderFrame</span><span class="token punctuation">(</span><span class="token parameter">frameState<span class="token punctuation">,</span> target</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// è®¡ç®—ç¼©æ”¾å’Œåç§»</span>
    <span class="token operator">...</span>

    <span class="token comment">// ç”ŸæˆDOM</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">useContainer</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> canvasTransform<span class="token punctuation">,</span> layerState<span class="token punctuation">.</span>opacity<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> context <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>context<span class="token punctuation">;</span>
    <span class="token keyword">const</span> canvas <span class="token operator">=</span> context<span class="token punctuation">.</span>canvas<span class="token punctuation">;</span>

    <span class="token keyword">const</span> replayGroup <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>replayGroup_<span class="token punctuation">;</span>
    <span class="token keyword">const</span> declutterExecutorGroup <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>declutterExecutorGroup<span class="token punctuation">;</span>

    <span class="token comment">// å¦‚æœreplayGroupé‡Œæ²¡æœ‰canvasæŒ‡ä»¤</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      <span class="token punctuation">(</span><span class="token operator">!</span>replayGroup <span class="token operator">||</span> replayGroup<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
      <span class="token punctuation">(</span><span class="token operator">!</span>declutterExecutorGroup <span class="token operator">||</span> declutterExecutorGroup<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>containerReused <span class="token operator">&amp;&amp;</span> canvas<span class="token punctuation">.</span>width <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        canvas<span class="token punctuation">.</span>width <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>container<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// æ¸…ç©ºç”»å¸ƒ, å‡†å¤‡ç»˜åˆ¶</span>
    <span class="token keyword">const</span> width <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span>frameState<span class="token punctuation">.</span>size<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> pixelRatio<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> height <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span>frameState<span class="token punctuation">.</span>size<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> pixelRatio<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>canvas<span class="token punctuation">.</span>width <span class="token operator">!=</span> width <span class="token operator">||</span> canvas<span class="token punctuation">.</span>height <span class="token operator">!=</span> height<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      canvas<span class="token punctuation">.</span>width <span class="token operator">=</span> width<span class="token punctuation">;</span>
      canvas<span class="token punctuation">.</span>height <span class="token operator">=</span> height<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>canvas<span class="token punctuation">.</span>style<span class="token punctuation">.</span>transform <span class="token operator">!==</span> canvasTransform<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        canvas<span class="token punctuation">.</span>style<span class="token punctuation">.</span>transform <span class="token operator">=</span> canvasTransform<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>containerReused<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      context<span class="token punctuation">.</span><span class="token function">clearRect</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> width<span class="token punctuation">,</span> height<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// æ ¹æ®replayGroupé‡Œçš„canvasæŒ‡ä»¤ç»˜åˆ¶</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">renderWorlds</span><span class="token punctuation">(</span>replayGroup<span class="token punctuation">,</span> frameState<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token operator">...</span>

    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>container<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><h4 id="ol-render-canvas-instruction"><a href="#ol-render-canvas-instruction" class="header-anchor">#</a> ol/render/canvas/Instruction</h4> <p>æ¯ä¸€ä¸ªæ•°å­—ä»£è¡¨ä¸€ä¸ªcanvasçš„æ“ä½œ</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> Instruction <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token constant">BEGIN_GEOMETRY</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token constant">BEGIN_PATH</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token constant">CIRCLE</span><span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
  <span class="token constant">CLOSE_PATH</span><span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
  <span class="token constant">CUSTOM</span><span class="token operator">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
  <span class="token constant">DRAW_CHARS</span><span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
  <span class="token constant">DRAW_IMAGE</span><span class="token operator">:</span> <span class="token number">6</span><span class="token punctuation">,</span>
  <span class="token constant">END_GEOMETRY</span><span class="token operator">:</span> <span class="token number">7</span><span class="token punctuation">,</span>
  <span class="token constant">FILL</span><span class="token operator">:</span> <span class="token number">8</span><span class="token punctuation">,</span>
  <span class="token constant">MOVE_TO_LINE_TO</span><span class="token operator">:</span> <span class="token number">9</span><span class="token punctuation">,</span>
  <span class="token constant">SET_FILL_STYLE</span><span class="token operator">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
  <span class="token constant">SET_STROKE_STYLE</span><span class="token operator">:</span> <span class="token number">11</span><span class="token punctuation">,</span>
  <span class="token constant">STROKE</span><span class="token operator">:</span> <span class="token number">12</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>å†ç»“åˆcanvaså‘½ä»¤ç»„, æ¯ä¸€ä¸ªæ•°ç»„çš„ç¬¬ä¸€ä¸ªæ•°å­—å°±æ˜¯å¯¹åº”ä¸Šé¢çš„å‘½ä»¤</p> <p><img src="./assets/img/08.d2ac40c1.png" alt="image"></p> <p>ç®€å•è§£é‡Šä¸€ä¸‹</p> <p>0: è®¾ç½®äº†fillæ ·å¼
1: è®¾ç½®äº†lineæ ·å¼
2: å¼€å§‹ç»˜åˆ¶geometry, ä¸€ç›´åˆ°ç¬¬8è¡Œéƒ½æ˜¯å…³äºè¿™ä¸ªfeatureçš„
3: å¼€å§‹ç»˜åˆ¶çº¿
4: ä»åæ ‡æ•°ç»„å†…çš„ 0 åˆ° 10 ä¾æ¬¡ç»˜åˆ¶
5: ç»“æŸç»˜åˆ¶çº¿
6: ä¸Šfill
7: ä¸Šline
8: è¿™ä¸ªfeatureç»˜åˆ¶å®Œæˆ
...
ä¸‹ä¸€ä¸ªfeature</p> <h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="header-anchor">#</a> æ€»ç»“</h2> <p>ä¸ç®¡æ˜¯å›¾ç‰‡è¿˜æ˜¯çŸ¢é‡çš„ç»˜åˆ¶, æˆ‘ä»¬éƒ½æ²¡æœ‰çœ‹åˆ°sourceæ˜¯æ€ä¹ˆå‚ä¸è¿›æ¥çš„</p> <p>è¿™æ˜¯openlayersæœ‰æ„åˆ†ç¦», rendereråªåšæ¸²æŸ“çš„äº‹æƒ…, è·å–æ•°æ®çš„äº‹æƒ…å®Œå…¨äº¤ç»™source.</p> <p>å°†æ¸²æŸ“å’Œæ•°æ®è·å–è¿›è¡Œåˆ†ç¦», è™½ç„¶ä¼šå¢åŠ ä»£ç çš„å¤æ‚æ€§, ä½†æ˜¯è¿™ä¹Ÿæ›´åŠ æ–¹ä¾¿äº†sourceçš„æ‰©å±•, ç”¨æˆ·å¯ä»¥æ ¹æ®è‡ªå·±æƒ³è¦çš„rendererç±»å‹, è‡ªå®šä¹‰sourceä»¥ä¾›openlayersåŠ è½½.</p> <p>ä¸‹ç¯‡æˆ‘å°†ä¼šå¯¹sourceè¿›è¡Œè¯¦ç»†çš„ä»‹ç»</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">4/19/2021, 3:11:48 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      â†
      <a href="/./dailyRecord/OpenLayers.html" class="prev">
        OpenLayers åŸºç¡€
      </a></span> <span class="next"><a href="/./dailyRecord/OLSourceCode2.html">
        OpenLayers æºç åˆ†æ(ä¸‹ç¯‡)
      </a>
      â†’
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="./assets/js/app.09835454.js" defer></script><script src="./assets/js/3.9a8cb714.js" defer></script><script src="./assets/js/11.a7dda998.js" defer></script>
  </body>
</html>
